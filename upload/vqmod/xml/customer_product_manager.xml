<modification>
	<id>Customer Product Manager (CPM) Multi-Vendor Membership Module for OpenCart</id>
	<version>2.3.2.1</version>
	<vqmver>2.4.0</vqmver>
	<author>garudacrafts</author>
	<notes>Please see http://opencart.garudacrafts.com/1561/ for more information, including installation instructions, FAQ, changelog, and more...</notes>
	
	<!-- SYSTEM -->
	
	<file name="system/library/customer.php">
		<operation>
			<search position="after"><![CDATA[
			private $customer_group_id;
			]]></search>
			<add><![CDATA[
			private $cpm_enabled;
			private $cpm_max_products;
			]]></add>
		</operation>
		<operation>
			<search position="after"><![CDATA[
			$this->customer_group_id = $customer_query->row['customer_group_id'];
			]]></search>
			<add><![CDATA[
			if ($this->config->get('cpm_status')) {
				$this->cpm_enabled = $customer_query->row['cpm_enabled'];
			} else {
				$this->cpm_enabled = '';
			}
			]]></add>
		</operation>
		<operation>
			<search position="after"><![CDATA[
			$this->customer_group_id = '';
			]]></search>
			<add><![CDATA[
			$this->cpm_enabled = '';
			]]></add>
		</operation>
		<operation>
			<search position="before"><![CDATA[
			public function getCustomerGroupId() {
			]]></search>
			<add><![CDATA[
			public function getCustomerProductManager() {
				return $this->cpm_enabled;	
			}
			public function getCPMImagesDirectory() {
				$query = $this->db->query("SELECT cpm_directory_images FROM " . DB_PREFIX . "customer_cpm_account WHERE customer_id = '" . (int)$this->customer_id . "'");
				return $query->row['cpm_directory_images'];
			}
			public function getCPMDownloadsDirectory() {
				$query = $this->db->query("SELECT cpm_directory_downloads FROM " . DB_PREFIX . "customer_cpm_account WHERE customer_id = '" . (int)$this->customer_id . "'");
				return $query->row['cpm_directory_downloads'];
			}
			public function getCPMMaxProducts() {
				$query = $this->db->query("SELECT cpm_max_products FROM " . DB_PREFIX . "customer_cpm_account WHERE customer_id = '" . (int)$this->customer_id . "'");
				return $query->row['cpm_max_products'];
			}
			public function getCPMCommissionRate() {
				$query = $this->db->query("SELECT cpm_commission_rate FROM " . DB_PREFIX . "customer_cpm_account WHERE customer_id = '" . (int)$this->customer_id . "'");
				return $query->row['cpm_commission_rate'];
			}
			]]></add>
		</operation>
	</file>
	
	<file name="system/library/cart.php">
		<operation>
			<search position="before"><![CDATA[
			$product_query = $this->db->query("SELECT *
			]]></search>
			<add><![CDATA[
			if ($this->config->get('cpm_status')) {
				$product_query = $this->db->query("SELECT p.product_id, pd.name, p.model, p.shipping, p.image, p.minimum, p.subtract, p.points, p.tax_class_id, p.weight, p.weight_class_id, p.length, p.length_class_id, p.width, p.height, p.price, p.quantity, p.cpm_customer_id, cpm.cpm_account_name AS member, cpm.cpm_commission_rate, cpm.cpm_account_image AS m_image FROM " . DB_PREFIX . "product p LEFT JOIN " . DB_PREFIX . "product_description pd ON (p.product_id = pd.product_id) LEFT JOIN " . DB_PREFIX . "customer_cpm_account cpm ON (p.cpm_customer_id = cpm.customer_id) WHERE p.product_id = '" . (int)$product_id . "' AND pd.language_id = '" . (int)$this->config->get('config_language_id') . "' AND p.date_available <= NOW() AND p.status = '1' AND p.cpm_approved = '1'");
			} else {
			]]></add>
		</operation>
		<operation>
			<search position="after"><![CDATA[
			$product_query = $this->db->query("SELECT *
			]]></search>
			<add><![CDATA[
			}
			]]></add>
		</operation>
		<operation>
			<search position="before"><![CDATA[
			$product_query->row['length_class_id']
			]]></search>
			<add><![CDATA[
			'cpm_customer_id' => (($this->config->get('cpm_status')) ? $product_query->row['cpm_customer_id'] : '' ),
			'member' => (($this->config->get('cpm_status')) ? $product_query->row['member'] : '' ),
			'cpm_commission_rate' => (($this->config->get('cpm_status')) ? $product_query->row['cpm_commission_rate'] : 0 ),
			]]></add>
		</operation>
	</file>

	<!-- START ADMIN -->
	
	<!-- ADMIN HEADER -->
	
	<file name="admin/controller/common/header.php">
		<operation>
			<search position="after"><![CDATA[
			$this->data['text_customer']
			]]></search>
			<add><![CDATA[
			$this->data['text_member'] = $this->language->get('text_member');
			$this->data['text_customer_members'] = $this->language->get('text_customer_members');
			$this->data['text_customer_non_members'] = $this->language->get('text_customer_non_members');
			$this->data['text_report_sale_member'] = $this->language->get('text_report_sale_member');
			]]></add>
		</operation>
		<operation>
			<search position="after"><![CDATA[
			$this->data['customer'] = $this->url->link('sale/customer', 'token=' . $this->session->data['token'], 'SSL');
			]]></search>
			<add><![CDATA[
			$this->data['member'] = $this->url->link('catalog/member', 'token=' . $this->session->data['token'], 'SSL');
			$this->data['customer_members'] = $this->url->link('sale/customer', 'token=' . $this->session->data['token'] . '&filter_cpm_member=1', 'SSL');
			$this->data['customer_non_members'] = $this->url->link('sale/customer', 'token=' . $this->session->data['token'] . '&filter_cpm_member=0', 'SSL');
			$this->data['report_sale_member'] = $this->url->link('report/sale_cpm_member', 'token=' . $this->session->data['token'], 'SSL');
			]]></add>
		</operation>
	</file>
	
	<file name="admin/language/english/common/header.php">
		<operation>
			<search position="bottom" offset="2"></search>
			<add><![CDATA[
			$_['text_member']						= 'Memberships';
			$_['text_customer_members']				= 'Members';
			$_['text_customer_non_members']			= 'Non-Members';
			$_['text_report_sale_member']			= 'Member Sales';
			]]></add>
		</operation>
	</file>
	
	<file name="admin/view/template/common/header.tpl">
		<operation>
			<search position="before"><![CDATA[
			<li><a href="<?php echo $manufacturer; ?>"><?php echo $text_manufacturer; ?></a></li>
			]]></search>
			<add><![CDATA[
			<li><a href="<?php echo $member; ?>"><?php echo $text_member; ?></a></li>
			]]></add>
		</operation>
		<operation>
			<search position="after"><![CDATA[
			<li><a href="<?php echo $customer; ?>"><?php echo $text_customer; ?></a></li>
			]]></search>
			<add><![CDATA[
			<li><a href="<?php echo $customer_members; ?>"><?php echo $text_customer_members; ?></a></li>
			<li><a href="<?php echo $customer_non_members; ?>"><?php echo $text_customer_non_members; ?></a></li>
			]]></add>
		</operation>
		<operation>
			<search position="before"><![CDATA[
			<li><a href="<?php echo $report_sale_order; ?>"><?php echo $text_report_sale_order; ?></a></li>
			]]></search>
			<add><![CDATA[
			<li><a href="<?php echo $report_sale_member; ?>"><?php echo $text_report_sale_member; ?></a></li>
			]]></add>
		</operation>
	</file>
	
	<!-- ADMIN HOME -->
	
	<file name="admin/controller/common/home.php">
		<operation>
			<search position="after"><![CDATA[
			$this->data['text_total_customer']
			]]></search>
			<add><![CDATA[
			$this->data['text_total_member'] = $this->language->get('text_total_member');
			$this->data['text_total_member_approval'] = $this->language->get('text_total_member_approval');
			$this->data['text_total_product'] = $this->language->get('text_total_product');
			$this->data['text_total_product_approval'] = $this->language->get('text_total_product_approval');
			]]></add>
		</operation>
		<operation>
			<search position="after"><![CDATA[
			getTotalCustomersAwaitingApproval
			]]></search>
			<add><![CDATA[
			if ($this->config->get('cpm_status')) {
				$this->data['total_member'] = $this->model_sale_customer->getTotalCPMCustomers();
				$this->data['total_member_href'] = $this->url->link('sale/customer', 'token=' . $this->session->data['token'] . '&filter_cpm_member=1', 'SSL');
				$data = array(
					'filter_approved'  => '0'
				);
				$this->data['total_member_approval'] = $this->model_sale_customer->getTotalCPMCustomers($data);
				$this->data['total_member_approval_href'] = $this->url->link('sale/customer', 'token=' . $this->session->data['token'] . '&filter_cpm_member=1&filter_approved=0', 'SSL');
				
				$this->load->model('catalog/product');
				$this->data['total_product'] = $this->model_catalog_product->getTotalProducts();
				$this->data['total_product_href'] = $this->url->link('catalog/product', 'token=' . $this->session->data['token'], 'SSL');
				$this->data['total_product_approval'] = $this->model_catalog_product->getTotalProductsAwaitingApproval();
				$this->data['total_product_approval_href'] = $this->url->link('catalog/product', 'token=' . $this->session->data['token'] . '&filter_approved=0', 'SSL');
			}
			]]></add>
		</operation>
	</file>
	
	<file name="admin/language/english/common/home.php">
		<operation>
			<search position="bottom" offset="2"></search>
			<add><![CDATA[
			$_['text_total_member']				= 'No. of Members:';
			$_['text_total_member_approval']	= 'Members Awaiting Approval:';
			$_['text_total_product']			= 'No. of Products:';
			$_['text_total_product_approval']	= 'Products Awaiting Approval:';
			]]></add>
		</operation>
	</file>
	
	<file name="admin/view/template/common/home.tpl">
		<operation>
			<search position="before" offset="1"><![CDATA[
			<?php echo $text_total_review_approval; ?></td>
			]]></search>
			<add><![CDATA[
			<?php if ($this->config->get('cpm_status')) { ?>
			    <tr>
			      <td class="left"><?php echo $text_total_member; ?></td>
			      <td class="right"><a href="<?php echo $total_member_href; ?>" title="<?php echo $text_total_member; ?>"><?php echo $total_member; ?></a></td>
			    </tr>
			    <tr>
			      <td class="left"><?php echo $text_total_member_approval; ?></td>
			      <td class="right"><a href="<?php echo $total_member_approval_href; ?>" title="<?php echo $text_total_member_approval; ?>" style="color:<?php echo ($total_member_approval == 0 ? '#8EC74B' : '#DC313E; font-weight:bold;'); ?>;"><?php echo $total_member_approval; ?></a></td>
			    </tr>
			    <tr>
			      <td class="left"><?php echo $text_total_product; ?></td>
			      <td class="right"><a href="<?php echo $total_product_href; ?>" title="<?php echo $text_total_product; ?>"><?php echo $total_product; ?></a></td>
			    </tr>
			    <tr>
			      <td class="left"><?php echo $text_total_product_approval; ?></td>
			      <td class="right"><a href="<?php echo $total_product_approval_href; ?>" title="<?php echo $text_total_product_approval; ?>" style="color:<?php echo ($total_product_approval == 0 ? '#8EC74B' : '#DC313E; font-weight:bold;'); ?>;"><?php echo $total_product_approval; ?></a></td>
			    </tr>
			<?php } ?>
			]]></add>
		</operation>
	</file>

	<!-- ADMIN CUSTOMER -->
	
	<file name="admin/controller/sale/customer.php">
		<operation>
			<search position="after"><![CDATA[
			$this->data['column_status']
			]]></search>
			<add><![CDATA[
			$this->data['column_cpm_member'] = sprintf($this->language->get('column_cpm_member'), $this->url->link('catalog/member', 'token=' . $this->session->data['token'] . $url, 'SSL'));
			]]></add>
		</operation>
		<operation>
			<search position="after"><![CDATA[
			$result['status'] ?
			]]></search>
			<add><![CDATA[
			'cpm_member' => ($this->model_sale_customer->checkMembership($result['customer_id']) ? $this->language->get('text_yes') : $this->language->get('text_no')),
			]]></add>
		</operation>
		<operation>
			<search position="after"><![CDATA[
			$this->data['filter_status'] = $filter_status;
			]]></search>
			<add><![CDATA[
			$this->data['filter_cpm_member'] = $filter_cpm_member;
			]]></add>
		</operation>
		<operation>
			<search position="before" offset="1"><![CDATA[
			$filter_status = $this->request->get['filter_status'];
			]]></search>
			<add><![CDATA[
			if (isset($this->request->get['filter_cpm_member'])) {
				$filter_cpm_member = $this->request->get['filter_cpm_member'];
			} else {
				$filter_cpm_member = null;
			}
			]]></add>
		</operation>
		<operation>
			<search position="before" offset="1"><![CDATA[
			$url .= '&filter_status=' . $this->request->get['filter_status'];
			]]></search>
			<add><![CDATA[			
			if (isset($this->request->get['filter_cpm_member'])) {
				$url .= '&filter_cpm_member=' . $this->request->get['filter_cpm_member'];
			}
			]]></add>
		</operation>
		<operation>
			<search position="before"><![CDATA[
			=> $filter_status,
			]]></search>
			<add><![CDATA[
			'filter_cpm_member' => $filter_cpm_member, 
			]]></add>
		</operation>
		<operation>
			<search position="after"><![CDATA[
			$this->data['sort_status']
			]]></search>
			<add><![CDATA[
			$this->data['sort_cpm_member'] = $this->url->link('sale/customer', 'token=' . $this->session->data['token'] . '&sort=cpm_member' . $url, 'SSL');
			]]></add>
		</operation>
		<operation>
			<search position="after"><![CDATA[
			$this->data['button_approve']
			]]></search>
			<add><![CDATA[
			$this->data['text_confirm'] = $this->language->get('text_confirm');
			]]></add>
		</operation>
		<operation>
			<search position="after"><![CDATA[
			function getForm() {
			]]></search>
			<add><![CDATA[
			$this->data['tab_cpm'] = $this->language->get('tab_cpm');
			$this->data['text_cpm'] = $this->language->get('text_cpm');
			$this->data['text_cpm_no_member'] = $this->language->get('text_cpm_no_member');
			$this->data['text_cpm_account_name'] = $this->language->get('text_cpm_account_name');
			$this->data['text_cpm_account_description'] = $this->language->get('text_cpm_account_description');
			$this->data['text_cpm_account_image'] = $this->language->get('text_cpm_account_image');
			$this->data['text_cpm_custom_field_01'] = $this->config->get('cpm_custom_field_01');
			$this->data['text_cpm_custom_field_02'] = $this->config->get('cpm_custom_field_02');
			$this->data['text_cpm_custom_field_03'] = $this->config->get('cpm_custom_field_03');
			$this->data['text_cpm_custom_field_04'] = $this->config->get('cpm_custom_field_04');
			$this->data['text_cpm_custom_field_05'] = $this->config->get('cpm_custom_field_05');
			$this->data['text_cpm_custom_field_06'] = $this->config->get('cpm_custom_field_06');
			$this->data['text_cpm_directory_images'] = $this->language->get('text_cpm_directory_images');
			$this->data['text_cpm_directory_downloads'] = $this->language->get('text_cpm_directory_downloads');
			$this->data['text_cpm_paypal_account'] = $this->language->get('text_cpm_paypal_account');
			$this->data['text_cpm_commission_rate'] = $this->language->get('text_cpm_commission_rate');
			$this->data['text_cpm_max_products'] = $this->language->get('text_cpm_max_products');
			$this->data['text_sort_order'] = $this->language->get('text_sort_order');
			$this->data['text_keyword'] = $this->language->get('text_keyword');
			$this->data['text_unknown'] = $this->language->get('text_unknown');
			$this->data['cpm_field_name'] = $this->language->get('cpm_field_name');
			$this->data['cpm_field_value'] = $this->language->get('cpm_field_value');
			]]></add>
		</operation>
		<operation>
			<search position="after" offset="1"><![CDATA[
			$customer_info = $this->model_sale_customer->getCustomer($this->request->get['customer_id']);
			]]></search>
			<add><![CDATA[
			if (!empty($customer_info) && isset($customer_info['cpm_account_id'])) {
				$this->data['cpm_member'] = true;				
			} else {
				$this->data['cpm_member'] = false;
			}
			
			if (!empty($customer_info) && isset($customer_info['cpm_enabled'])) {
				$this->data['cpm_enabled'] = $this->language->get('text_cpm_enabled');
			} else {
				$this->data['cpm_enabled'] = $this->language->get('text_cpm_disabled');
			}
			
			$cpm_data_fields = array('cpm_account_name', 'cpm_account_description', 'cpm_account_image', 'cpm_custom_field_01', 'cpm_custom_field_02', 'cpm_custom_field_03', 'cpm_custom_field_04', 'cpm_custom_field_05', 'cpm_custom_field_06', 'cpm_directory_images', 'cpm_directory_downloads', 'cpm_max_products', 'cpm_commission_rate', 'cpm_paypal_account', 'sort_order', 'keyword');

			foreach ($cpm_data_fields as $cpm_data_field) {
				if (!empty($customer_info) && isset($customer_info[$cpm_data_field])) { 
					$this->data[$cpm_data_field] = $customer_info[$cpm_data_field];
				} else {
					$this->data[$cpm_data_field] = '';
				}
			}
			
			if (!empty($customer_info) && isset($customer_info['cpm_account_description'])) {
				$this->data['cpm_account_description'] = html_entity_decode($customer_info['cpm_account_description'], ENT_QUOTES);				
			} else {
				$this->data['cpm_account_description'] = '';
			}
			
			if (!empty($customer_info) && isset($customer_info['cpm_account_name'])) {
				$this->data['help_cpm_member'] = sprintf($this->language->get('help_cpm_member'), $this->url->link('catalog/member/update', 'token=' . $this->session->data['token'] . '&member_id=' . $this->request->get['customer_id'], 'SSL'), '"'. $customer_info['cpm_account_name'] . '"');
			} else {
				$this->data['help_cpm_member'] = sprintf($this->language->get('help_cpm_no_member'), $this->url->link('catalog/member', 'token=' . $this->session->data['token'], 'SSL'));
			}
			
			if (!empty($customer_info) && isset($customer_info['viewed'])) {
				$this->data['text_viewed'] = sprintf($this->language->get('text_viewed'), $customer_info['viewed']);
			} else {
				$this->data['text_viewed'] = sprintf($this->language->get('text_viewed'), $this->language->get('text_unknown'));
			}

			$this->load->model('tool/image');
		
			if (!empty($customer_info) && !empty($customer_info['cpm_account_image']) && file_exists(DIR_IMAGE . $customer_info['cpm_account_image'])) {
				$this->data['cpm_account_image_thumb'] = $this->model_tool_image->resize($customer_info['cpm_account_image'], 100, 100);
			} else {
				$this->data['cpm_account_image_thumb'] = $this->model_tool_image->resize('no_image.jpg', 100, 100);
			}

			$this->data['no_image'] = $this->model_tool_image->resize('no_image.jpg', 100, 100);
			]]></add>
		</operation>
	</file>
	
	<file name="admin/model/sale/customer.php">
		<operation>
			<search position="after" offset="2"><![CDATA[
			function getCustomers(
			]]></search>
			<add><![CDATA[
			}

			if (!empty($data['filter_cpm_enabled'])) {
				$sql = "SELECT *, LCASE(CONCAT(lastname, ', ', firstname)) AS fullname FROM " . DB_PREFIX . "customer WHERE cpm_enabled = '" . (int)$data['filter_cpm_enabled'] . "' ORDER BY fullname ASC";
				$query = $this->db->query($sql);
				return $query->rows;
			}
			
			if (!empty($data['filter_cpm_customer_name'])) {
				$sql = "SELECT customer_id, LCASE(CONCAT(lastname, ', ', firstname)) AS fullname FROM " . DB_PREFIX . "customer WHERE cpm_enabled = '1' AND LCASE(CONCAT(lastname, ', ', firstname)) LIKE '" . $this->db->escape(utf8_strtolower($data['filter_cpm_customer_name'])) . "%'";		
				$sql .= " LIMIT " . (int)$data['start'] . "," . (int)$data['limit'];
				$query = $this->db->query($sql);
				return $query->rows;
			}
			]]></add>
		</operation>
		<operation>
			<search position="after"><![CDATA[
			function getCustomers(
			]]></search>
			<add><![CDATA[
			if ($this->config->get('cpm_status')) {
				$sql = "SELECT c.*, CONCAT(c.firstname, ' ', c.lastname) AS name, cpm.cpm_account_id IS NOT NULL AS cpm_member, cgd.name AS customer_group 
						FROM " . DB_PREFIX . "customer c 
						LEFT JOIN " . DB_PREFIX . "customer_cpm_account cpm ON (c.customer_id = cpm.customer_id) 
						LEFT JOIN " . DB_PREFIX . "customer_group_description cgd ON (c.customer_group_id = cgd.customer_group_id) 
						WHERE cgd.language_id = '" . (int)$this->config->get('config_language_id') . "'";
			} else {
			]]></add>
		</operation>
		<operation>
			<search position="before" offset="1"><![CDATA[
			$implode[] = "c.status = '" . (int)$data['filter_status'] . "'";
			]]></search>
			<add><![CDATA[			
			if (isset($data['filter_cpm_member']) && !is_null($data['filter_cpm_member'])) {
				if ((int)$data['filter_cpm_member'] == 0) {
					$implode[] = "cpm.cpm_account_id IS NULL";
				} else {
					$implode[] = "cpm.cpm_account_id IS NOT NULL";
				}
			}
			]]></add>
		</operation>
		<operation>
			<search position="after" offset="2"><![CDATA[
			function getTotalCustomers(
			]]></search>
			<add><![CDATA[
			}
			]]></add>
		</operation>
		<operation>
			<search position="after"><![CDATA[
			function getTotalCustomers(
			]]></search>
			<add><![CDATA[
			if ($this->config->get('cpm_status')) {
				$sql = "SELECT COUNT(*) AS total FROM " . DB_PREFIX . "customer c LEFT JOIN " . DB_PREFIX . "customer_cpm_account cpm ON (c.customer_id = cpm.customer_id)";
			} else {
			]]></add>
		</operation>
		<operation>
			<search position="replace" offset="1"><![CDATA[
			$implode[] = "customer_id IN (SELECT customer_id FROM " . DB_PREFIX . "customer_ip WHERE ip = '" . $this->db->escape($data['filter_ip']) . "')";
			]]></search>
			<add><![CDATA[
				if ($this->config->get('cpm_status')) {
					$implode[] = "c.customer_id IN (SELECT cip.customer_id FROM " . DB_PREFIX . "customer_ip cip WHERE cip.ip = '" . $this->db->escape($data['filter_ip']) . "')";
				} else {
					$implode[] = "customer_id IN (SELECT customer_id FROM " . DB_PREFIX . "customer_ip WHERE ip = '" . $this->db->escape($data['filter_ip']) . "')";
				}
			}
			
			if (isset($data['filter_cpm_member']) && !is_null($data['filter_cpm_member'])) {
				if ((int)$data['filter_cpm_member'] == 0) {
					$implode[] = "cpm.cpm_account_id IS NULL";
				} else {
					$implode[] = "cpm.cpm_account_id IS NOT NULL";
				}
			}
			]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[
			$implode[] = "DATE(date_added) = DATE('" . $this->db->escape($data['filter_date_added']) . "')";
			]]></search>
			<add><![CDATA[
			if ($this->config->get('cpm_status')) {
				$implode[] = "DATE(c.date_added) = DATE('" . $this->db->escape($data['filter_date_added']) . "')";
			} else {
				$implode[] = "DATE(date_added) = DATE('" . $this->db->escape($data['filter_date_added']) . "')";
			}
			]]></add>
		</operation>
		<operation>
			<search position="after"><![CDATA[
			'c.status',
			]]></search>
			<add><![CDATA[
			'cpm_member',
			]]></add>
		</operation>
		<operation>
			<search position="after"><![CDATA[
			$this->db->query("DELETE FROM " . DB_PREFIX . "customer_ip
			]]></search>
			<add><![CDATA[
			$this->db->query("DELETE FROM " . DB_PREFIX . "customer_cpm_account WHERE customer_id = '" . (int)$customer_id . "'");
			$this->db->query("DELETE FROM " . DB_PREFIX . "url_alias WHERE query = 'member_id=" . (int)$customer_id. "'");
			]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[
			$query = $this->db->query("SELECT DISTINCT * FROM " . DB_PREFIX . "customer WHERE customer_id = '" . (int)$customer_id . "'");
			]]></search>
			<add><![CDATA[
			// return customer with CPM account info if CPM is enabled
			if ($this->config->get('cpm_status')) {
				$query = $this->db->query("SELECT DISTINCT *, (SELECT keyword FROM " . DB_PREFIX . "url_alias WHERE query = 'member_id=" . (int)$customer_id . "') AS keyword FROM " . DB_PREFIX . "customer c LEFT JOIN " . DB_PREFIX . "customer_cpm_account cca ON (c.customer_id = cca.customer_id) WHERE c.customer_id = '" . (int)$customer_id . "'");
				return $query->row;
			} else {
				$query = $this->db->query("SELECT DISTINCT * FROM " . DB_PREFIX . "customer WHERE customer_id = '" . (int)$customer_id . "'");
			}
			]]></add>
		</operation>
		<operation>
			<search position="replace" offset="1"><![CDATA[
			public function getTotalCustomersAwaitingApproval() {
			]]></search>
			<add><![CDATA[
			public function getTotalCPMCustomers($data = array()) {
				$sql = "SELECT COUNT(*) AS total FROM " . DB_PREFIX . "customer WHERE cpm_enabled = '1'";			
		
				if (isset($data['filter_approved'])) {
					$sql .=  " AND approved = '" . (int)$data['filter_approved'] . "'";
				}
				
				if (!empty($data['filter_customer_group_id'])) {
					$sql .=  " AND customer_group_id = '" . (int)$data['filter_customer_group_id'] . "'";
				}
				
				$query = $this->db->query($sql);
				return $query->row['total'];
			}
			
			public function getTotalCustomersAwaitingApproval() {
				if ($this->config->get('cpm_status')) {
					$query = $this->db->query("SELECT COUNT(*) AS total FROM " . DB_PREFIX . "customer WHERE approved = '0' AND cpm_enabled = '0'");
				} else {
					$query = $this->db->query("SELECT COUNT(*) AS total FROM " . DB_PREFIX . "customer WHERE status = '0' OR approved = '0'");
				}
			]]></add>
		</operation>
		<operation>
			<search position="bottom" offset="2"><![CDATA[]]></search>
			<add><![CDATA[
			public function checkMembership($customer_id) {
				$query = $this->db->query("SELECT cpm_account_id FROM " . DB_PREFIX . "customer_cpm_account WHERE customer_id = '" . (int)$customer_id . "'");		
				
				if (!empty($query->row)) {
					return $query->row['cpm_account_id'];
				} else {
					return 0;
				}
			}
			]]></add>
		</operation>
	</file>

	<file name="admin/language/english/sale/customer.php">
		<operation>
			<search position="bottom" offset="2"></search>
			<add><![CDATA[
			// CPM Module Extension
			$_['tab_cpm']                			= 'Membership';
			$_['column_cpm_member']                 = '<a href="%s">Member Account</a>';
			$_['text_cpm'] 							= 'Membership Status:';
			$_['text_cpm_enabled']          		= 'Membership-Enabled';
			$_['text_cpm_disabled']          		= 'Membership-Disabled';
			$_['help_cpm_member'] 					= 'This Customer is linked to <a href="%s" target="_blank">Member Account %s</a>.';
			$_['help_cpm_no_member'] 				= 'This Customer is <b>NOT</b> linked to any <a href="%s" target="_blank">Member Account</a>.';
			$_['text_cpm_account_name'] 			= 'Member Account Name:';
			$_['text_cpm_account_description'] 		= 'Member Account Description:';
			$_['text_cpm_account_image'] 			= 'Member Account Image:';
			$_['text_cpm_directory_images']			= 'Image Upload Directory:';
			$_['text_cpm_directory_downloads']  	= 'Downloads Directory:';
			$_['text_cpm_paypal_account']			= 'PayPal Account E-mail:';
			$_['text_cpm_max_products'] 			= 'Max Products:';
			$_['text_cpm_commission_rate'] 			= 'Commission Rate (%):';
			$_['text_sort_order'] 					= 'Sort Order:';
			$_['text_keyword'] 						= 'Keyword:';
			$_['text_viewed'] 						= 'The Member Page has been viewed <b>%s</b> times.';
			$_['text_unknown'] 						= 'an unknown number of';			
			$_['text_confirm']            			= 'Confirm Delete?\n\rAny linked Member Account will also be deleted!';
			$_['cpm_field_name']                	= 'Name';
			$_['cpm_field_value']               	= 'Value';
			$_['text_cpm_no_member'] 				= 'Customer Account must be linked to a Member Account to Membership-Enable or Membership-Disable.';
			]]></add>
		</operation>
	</file>
	
	<file name="admin/view/template/sale/customer_list.tpl">
		<operation>
			<search position="before"><![CDATA[
			<td class="left"><?php if ($sort == 'c.status') { ?>
			]]></search>
			<add><![CDATA[
			<?php if ($this->config->get('cpm_status')) { ?>
			<td class="left"><?php if ($sort == 'cpm_member') { ?>
				<a href="<?php echo $sort_cpm_member; ?>" class="<?php echo strtolower($order); ?>"><?php echo $column_cpm_member; ?></a>
				<?php } else { ?>
				<a href="<?php echo $sort_cpm_member; ?>"><?php echo $column_cpm_member; ?></a>
				<?php } ?></td>
			<?php } ?>
			]]></add>
		</operation>
		<operation>
			<search position="before"><![CDATA[
			<td><select name="filter_status">
			]]></search>
			<add><![CDATA[
			<?php if ($this->config->get('cpm_status')) { ?>
              <td><select name="filter_cpm_member">
                  <option value="*"></option>
                  <?php if ($filter_cpm_member) { ?>
                  <option value="1" selected="selected"><?php echo $text_yes; ?></option>
                  <?php } else { ?>
                  <option value="1"><?php echo $text_yes; ?></option>
                  <?php } ?>
                  <?php if (!is_null($filter_cpm_member) && !$filter_cpm_member) { ?>
                  <option value="0" selected="selected"><?php echo $text_no; ?></option>
                  <?php } else { ?>
                  <option value="0"><?php echo $text_no; ?></option>
                  <?php } ?>
                </select></td>
			<?php } ?>
			]]></add>
		</operation>
		<operation>
			<search position="before"><![CDATA[
			<td class="left"><?php echo $customer['status']; ?></td>
			]]></search>
			<add><![CDATA[
			<?php if ($this->config->get('cpm_status')) { ?>
			<td class="left" style="color:#FFF;font-weight:bold;background:<?php echo ($customer['cpm_member'] === $text_yes ? '#CF00FF' : '#FFCC00'); ?>;"><?php echo $customer['cpm_member']; ?></td>
			<?php } ?>
			]]></add>
		</operation>
		<operation>
			<search position="before"><![CDATA[
			var filter_status = $('select[name=\'filter_status\']').attr('value');
			]]></search>
			<add><![CDATA[
			var filter_cpm_member = $('select[name=\'filter_cpm_member\']').attr('value');
			
			if (filter_cpm_member != '*') {
				url += '&filter_cpm_member=' + encodeURIComponent(filter_cpm_member);
			}
			]]></add>
		</operation>
		<operation>
			<search position="before"><![CDATA[
			<?php echo $footer; ?>
			]]></search>
			<add><![CDATA[
			<script type="text/javascript"><!--
			$('#form input').keydown(function(e) {
				if (e.keyCode == 13) {
					filter();
				}
			});
			//--></script>
			<script type="text/javascript">
			$(document).ready(function(){
				// Confirm Delete
				$('#form').submit(function(){
					if ($(this).attr('action').indexOf('delete',1) != -1) {
						if (!confirm('<?php echo $text_confirm; ?>')) {
							return false;
						}
					}
				});
			});
			</script>
			]]></add>
		</operation>
	</file>

	<file name="admin/view/template/sale/customer_form.tpl">
		<operation>
			<search position="after"><![CDATA[
			<a href="#tab-general"><?php echo $tab_general; ?></a>
			]]></search>
			<add><![CDATA[
			<?php if ($this->config->get('cpm_status')) { ?>
			<a href="#tab-cpm"><?php echo $tab_cpm; ?></a>
			<?php } ?>
			]]></add>
		</operation>
		<operation>
			<search position="before"><![CDATA[
			</form>
			]]></search>
			<add><![CDATA[
			<?php if ($this->config->get('cpm_status')) { ?>
			<div id="tab-cpm">
				<table class="form">
					<tr>
					  <td style="border-bottom:none;"><?php echo $text_cpm; ?></td>
					  <td style="border-bottom:none;"><p><span class="help"><?php echo $help_cpm_member; ?>&nbsp;<?php echo ($cpm_member ? $text_viewed : $text_cpm_no_member); ?></span></p></td>
					</tr>
				</table>
				<?php if ($cpm_member) { ?>
				<h2>Member Account Info</h2>
				<table class="form">
				    <tr>
				      <td><?php echo $text_cpm_account_name; ?></td>
				      <td><?php echo $cpm_account_name; ?></td>
				    </tr>
				    <tr>
				      <td><?php echo $text_cpm_account_description; ?></td>
				      <td><?php echo $cpm_account_description; ?></td>
				    </tr>
				    <tr>
				      <td><?php echo $text_cpm_account_image; ?></td>				    
				      <td><div class="image"><img src="<?php echo $cpm_account_image_thumb; ?>" alt="" id="cpm_account_image_thumb" />
				    </tr>
				    <tr>
				      <td><?php echo $text_keyword; ?></td>
				      <td><?php echo $keyword; ?></td>
				    </tr>
				    <tr>
				      <td><?php echo $text_sort_order; ?></td>
				      <td><?php echo $sort_order; ?></td>
				    </tr>
				</table>
				<h2>Membership Settings</h2>
				<table class="form">
				    <tr>
				      <td><?php echo $text_cpm_directory_images; ?></td>
				      <td><?php echo $cpm_directory_images; ?></td>
				      </tr>
				    <tr>
				      <td><?php echo $text_cpm_directory_downloads; ?></td>
				      <td><?php echo $cpm_directory_downloads; ?></td>
				      </tr>
				    <tr>
				      <td><?php echo $text_cpm_paypal_account; ?></td>
				      <td><?php echo $cpm_paypal_account; ?></td>
				      </tr>
				    <tr>
				      <td><?php echo $text_cpm_max_products; ?></td>
				      <td><?php echo $cpm_max_products; ?></td>
				    </tr>
				    <tr>
				      <td><?php echo $text_cpm_commission_rate; ?></td>
				      <td><?php echo $cpm_commission_rate; ?> %</td>
				    </tr>
				</table>
				<div id="custom-fields" <?php if (!$text_cpm_custom_field_01 && !$text_cpm_custom_field_02 && !$text_cpm_custom_field_03 && !$text_cpm_custom_field_04 && !$text_cpm_custom_field_05 && !$text_cpm_custom_field_06) echo 'style="display:none;"'; ?>>
				<h2>Custom Fields</h2>
				<table class="form">
				   <tr <?php if (!$text_cpm_custom_field_01) echo 'style="display:none;"'; ?>>
				      <td><?php echo $text_cpm_custom_field_01; ?></td>
				      <td><?php echo $cpm_custom_field_01; ?></td>
				    </tr>
				    <tr <?php if (!$text_cpm_custom_field_02) echo 'style="display:none;"'; ?>>
				      <td><?php echo $text_cpm_custom_field_02; ?></td>
				      <td><?php echo $cpm_custom_field_02; ?></td>
				    </tr>
				    <tr <?php if (!$text_cpm_custom_field_03) echo 'style="display:none;"'; ?>>
				      <td><?php echo $text_cpm_custom_field_03; ?></td>
				      <td><?php echo $cpm_custom_field_03; ?></td>
				    </tr>
				   <tr <?php if (!$text_cpm_custom_field_04) echo 'style="display:none;"'; ?>>
				      <td><?php echo $text_cpm_custom_field_04; ?></td>
				      <td><?php echo $cpm_custom_field_04; ?></td>
				    </tr>
				    <tr <?php if (!$text_cpm_custom_field_05) echo 'style="display:none;"'; ?>>
				      <td><?php echo $text_cpm_custom_field_05; ?></td>
				      <td><?php echo $cpm_custom_field_05; ?></td>
				    </tr>
				    <tr <?php if (!$text_cpm_custom_field_06) echo 'style="display:none;"'; ?>>
				      <td><?php echo $text_cpm_custom_field_06; ?></td>
				      <td><?php echo $cpm_custom_field_06; ?></td>
				    </tr>
				</table>
				</div>
				<?php } // end if cpm enabled ?>
			</div>
			<?php } // end if cpm status ?>
			]]></add>
		</operation>
	</file>
	
	<!-- ADMIN PRODUCT -->
	
	<file name="admin/controller/catalog/product.php">
		<operation>
			<search position="before" index="1"><![CDATA[
			$this->data['text_enabled'] = $this->language->get('text_enabled');
			]]></search>
			<add><![CDATA[
			$this->data['text_yes'] = $this->language->get('text_yes');
			$this->data['text_no'] = $this->language->get('text_no');
			]]></add>
		</operation>
		<operation>
			<search position="before"><![CDATA[
			$this->data['entry_status'] = $this->language->get('entry_status');
			]]></search>
			<add><![CDATA[
			$this->data['entry_approved'] = $this->language->get('entry_approved');
			$this->data['entry_customer'] = $this->language->get('entry_customer');
			]]></add>
		</operation>
		<operation>
			<search position="before"><![CDATA[
			$this->data['button_insert']
			]]></search>
			<add><![CDATA[
			$this->data['button_approve'] = $this->language->get('button_approve');
			$this->data['button_enable'] = $this->language->get('button_enable');
			$this->data['button_disable'] = $this->language->get('button_disable');
			$this->data['button_update_cpm_customer'] = $this->language->get('button_update_cpm_customer');
			]]></add>
		</operation>
		<operation>
			<search position="before"><![CDATA[
			$this->data['insert']
			]]></search>
			<add><![CDATA[
			$this->data['approve'] = $this->url->link('catalog/product/approve', 'token=' . $this->session->data['token'] . $url, 'SSL');
			$this->data['enable'] = $this->url->link('catalog/product/enable', 'token=' . $this->session->data['token'] . $url, 'SSL');
			$this->data['disable'] = $this->url->link('catalog/product/disable', 'token=' . $this->session->data['token'] . $url, 'SSL');
			$this->data['update_cpm_customer'] = $this->url->link('catalog/product/updatecpmcustomer', 'token=' . $this->session->data['token'] . $url, 'SSL');
			]]></add>
		</operation>
		<operation>
			<search position="before"><![CDATA[
			function getList() {
			]]></search>
			<add><![CDATA[
			public function approve() {
				  $this->load->language('catalog/product');
				  
				  $this->document->setTitle($this->language->get('heading_title'));
				  
				  $this->load->model('catalog/product');
				  
				  if (!$this->user->hasPermission('modify', 'catalog/product')) {
					  $this->error['warning'] = $this->language->get('error_permission');
				  } elseif (isset($this->request->post['selected'])) {
					  $approved_count = 0;
					  
					  foreach ($this->request->post['selected'] as $product_id) {
						  $product_info = $this->model_catalog_product->getProduct($product_id);
						  
						  if ($product_info && !$product_info['cpm_approved']) {
							  $this->model_catalog_product->approveProduct($product_id);
							  
							  $approved_count++;
						  }
					  } 
					  
					  $this->session->data['success'] = sprintf($this->language->get('text_product_approved'), $approved_count);	
					  
					  $url = '';
							
					  if (isset($this->request->get['cpm_filter_name'])) {
						  $url .= '&cpm_filter_name=' . urlencode(html_entity_decode($this->request->get['cpm_filter_name'], ENT_QUOTES, 'UTF-8'));
					  }
					
					  if (isset($this->request->get['filter_model'])) {
						  $url .= '&filter_model=' . urlencode(html_entity_decode($this->request->get['filter_model'], ENT_QUOTES, 'UTF-8'));
					  }
					  
					  if (isset($this->request->get['filter_price'])) {
						  $url .= '&filter_price=' . $this->request->get['filter_price'];
					  }
					  
					  if (isset($this->request->get['filter_quantity'])) {
						  $url .= '&filter_quantity=' . $this->request->get['filter_quantity'];
					  }
					  
					  if (isset($this->request->get['filter_status'])) {
						  $url .= '&filter_status=' . $this->request->get['filter_status'];
					  }
							  
					  if (isset($this->request->get['sort'])) {
						  $url .= '&sort=' . $this->request->get['sort'];
					  }
		  
					  if (isset($this->request->get['order'])) {
						  $url .= '&order=' . $this->request->get['order'];
					  }
		  
					  if (isset($this->request->get['page'])) {
						  $url .= '&page=' . $this->request->get['page'];
					  }
									
					  $this->redirect($this->url->link('catalog/product', 'token=' . $this->session->data['token'] . $url, 'SSL'));			
				  } else {
					$this->error['warning'] = $this->language->get('error_notchecked');
				  }
				  
				  $this->getList();
			  }

			public function enable() {
				  $this->load->language('catalog/product');
				  
				  $this->document->setTitle($this->language->get('heading_title'));
				  
				  $this->load->model('catalog/product');
				  
				  if (!$this->user->hasPermission('modify', 'catalog/product')) {
					  $this->error['warning'] = $this->language->get('error_permission');
				  } elseif (isset($this->request->post['selected'])) {
					  $enabled_count = 0;
					  
					  foreach ($this->request->post['selected'] as $product_id) {
						  $product_info = $this->model_catalog_product->getProduct($product_id);
						  
						  if ($product_info && !$product_info['status']) {
							  $this->model_catalog_product->enableProduct($product_id);
							  
							  $enabled_count++;
						  }
					  } 
					  
					  $this->session->data['success'] = sprintf($this->language->get('text_product_enabled'), $enabled_count);	
					  
					  $url = '';
							
					  if (isset($this->request->get['cpm_filter_name'])) {
						  $url .= '&cpm_filter_name=' . urlencode(html_entity_decode($this->request->get['cpm_filter_name'], ENT_QUOTES, 'UTF-8'));
					  }
					
					  if (isset($this->request->get['filter_model'])) {
						  $url .= '&filter_model=' . urlencode(html_entity_decode($this->request->get['filter_model'], ENT_QUOTES, 'UTF-8'));
					  }
					  
					  if (isset($this->request->get['filter_price'])) {
						  $url .= '&filter_price=' . $this->request->get['filter_price'];
					  }
					  
					  if (isset($this->request->get['filter_quantity'])) {
						  $url .= '&filter_quantity=' . $this->request->get['filter_quantity'];
					  }
					  
					  if (isset($this->request->get['filter_status'])) {
						  $url .= '&filter_status=' . $this->request->get['filter_status'];
					  }
							  
					  if (isset($this->request->get['sort'])) {
						  $url .= '&sort=' . $this->request->get['sort'];
					  }
		  
					  if (isset($this->request->get['order'])) {
						  $url .= '&order=' . $this->request->get['order'];
					  }
		  
					  if (isset($this->request->get['page'])) {
						  $url .= '&page=' . $this->request->get['page'];
					  }
									
					  $this->redirect($this->url->link('catalog/product', 'token=' . $this->session->data['token'] . $url, 'SSL'));			
				  } else {
					$this->error['warning'] = $this->language->get('error_notchecked');
				  }
				  
				  $this->getList();
			  }

			public function disable() {
				  $this->load->language('catalog/product');
				  
				  $this->document->setTitle($this->language->get('heading_title'));
				  
				  $this->load->model('catalog/product');
				  
				  if (!$this->user->hasPermission('modify', 'catalog/product')) {
					  $this->error['warning'] = $this->language->get('error_permission');
				  } elseif (isset($this->request->post['selected'])) {
					  $disabled_count = 0;
					  
					  foreach ($this->request->post['selected'] as $product_id) {
						  $product_info = $this->model_catalog_product->getProduct($product_id);
						  
						  if ($product_info && $product_info['status']) {
							  $this->model_catalog_product->disableProduct($product_id);
							  
							  $disabled_count++;
						  }
					  } 
					  
					  $this->session->data['success'] = sprintf($this->language->get('text_product_disabled'), $disabled_count);	
					  
					  $url = '';
							
					  if (isset($this->request->get['cpm_filter_name'])) {
						  $url .= '&cpm_filter_name=' . urlencode(html_entity_decode($this->request->get['cpm_filter_name'], ENT_QUOTES, 'UTF-8'));
					  }
					
					  if (isset($this->request->get['filter_model'])) {
						  $url .= '&filter_model=' . urlencode(html_entity_decode($this->request->get['filter_model'], ENT_QUOTES, 'UTF-8'));
					  }
					  
					  if (isset($this->request->get['filter_price'])) {
						  $url .= '&filter_price=' . $this->request->get['filter_price'];
					  }
					  
					  if (isset($this->request->get['filter_quantity'])) {
						  $url .= '&filter_quantity=' . $this->request->get['filter_quantity'];
					  }
					  
					  if (isset($this->request->get['filter_status'])) {
						  $url .= '&filter_status=' . $this->request->get['filter_status'];
					  }
							  
					  if (isset($this->request->get['sort'])) {
						  $url .= '&sort=' . $this->request->get['sort'];
					  }
		  
					  if (isset($this->request->get['order'])) {
						  $url .= '&order=' . $this->request->get['order'];
					  }
		  
					  if (isset($this->request->get['page'])) {
						  $url .= '&page=' . $this->request->get['page'];
					  }
									
					  $this->redirect($this->url->link('catalog/product', 'token=' . $this->session->data['token'] . $url, 'SSL'));			
				  } else {
					$this->error['warning'] = $this->language->get('error_notchecked');
				  }
				  
				  $this->getList();
			  }
			  
			public function updateCPMCustomer() {
				  $this->load->language('catalog/product');
				  
				  $this->document->setTitle($this->language->get('heading_title'));
				  
				  $this->load->model('catalog/product');
				  
				  if (!$this->user->hasPermission('modify', 'catalog/product')) {
					  $this->error['warning'] = $this->language->get('error_permission');
				  } elseif (isset($this->request->post['selected'])) {
					  $updated_count = 0;
					  $cpm_customer_id = $this->request->post['cpm_customer_id'];
					  
					  foreach ($this->request->post['selected'] as $product_id) {
						  $product_info = $this->model_catalog_product->getProduct($product_id);
						  
						  if ($product_info) {
							  $this->model_catalog_product->updateProductCPMCustomer($product_id, $cpm_customer_id);
							  $updated_count++;
						  }
					  } 
					  
					  $this->session->data['success'] = sprintf($this->language->get('text_product_updated_cpm_customer'), $updated_count);	
					  
					  $url = '';
							
					  if (isset($this->request->get['cpm_filter_name'])) {
						  $url .= '&cpm_filter_name=' . urlencode(html_entity_decode($this->request->get['cpm_filter_name'], ENT_QUOTES, 'UTF-8'));
					  }
					
					  if (isset($this->request->get['filter_model'])) {
						  $url .= '&filter_model=' . urlencode(html_entity_decode($this->request->get['filter_model'], ENT_QUOTES, 'UTF-8'));
					  }
					  
					  if (isset($this->request->get['filter_price'])) {
						  $url .= '&filter_price=' . $this->request->get['filter_price'];
					  }
					  
					  if (isset($this->request->get['filter_quantity'])) {
						  $url .= '&filter_quantity=' . $this->request->get['filter_quantity'];
					  }
					  
					  if (isset($this->request->get['filter_status'])) {
						  $url .= '&filter_status=' . $this->request->get['filter_status'];
					  }
							  
					  if (isset($this->request->get['sort'])) {
						  $url .= '&sort=' . $this->request->get['sort'];
					  }
		  
					  if (isset($this->request->get['order'])) {
						  $url .= '&order=' . $this->request->get['order'];
					  }
		  
					  if (isset($this->request->get['page'])) {
						  $url .= '&page=' . $this->request->get['page'];
					  }
									
					  $this->redirect($this->url->link('catalog/product', 'token=' . $this->session->data['token'] . $url, 'SSL'));			
				  } else {
					$this->error['warning'] = $this->language->get('error_notchecked');
				  }
				  
				  $this->getList();
			  }
			]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[
			$sort = 'pd.name';
			]]></search>
			<add><![CDATA[
			$sort = 'p.cpm_approved';
			]]></add>
		</operation>
		<operation>
			<search position="before"><![CDATA[
			if (isset($this->request->post['status'])) {
			]]></search>
			<add><![CDATA[
			if (isset($this->request->post['approved'])) {
				$this->data['approved'] = $this->request->post['approved'];
			} elseif (!empty($product_info)) {
				$this->data['approved'] = $product_info['cpm_approved'];
			} else {
				$this->data['approved'] = 0;  // default cpm product not approved
			}
			if (isset($this->request->post['customer_id'])) {
				$this->data['customer_id'] = $this->request->post['customer_id'];
			} elseif (!empty($product_info)) {
				$this->data['customer_id'] = $product_info['cpm_customer_id'];
			} else {
				$this->data['customer_id'] = 0;  // default cpm no customer linked
			}
			]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[
			'status'     => ($result['status'] ? $this->language->get('text_enabled') : $this->language->get('text_disabled')),
			]]></search>
			<add><![CDATA[
			'approved'     => (!empty($result['cpm_approved']) ? $this->language->get('text_yes') : $this->language->get('text_no')),
			'customer_id'     => (!empty($result['cpm_customer_id']) ? $result['cpm_customer_id'] : ''),
			'customer'	=> (!empty($result['fullname']) ? $result['fullname'] : ''),
			'status'     => ($result['status'] ? $this->language->get('text_enabled') : $this->language->get('text_disabled')),
			]]></add>
		</operation>
		<operation>
			<search position="before"><![CDATA[
			$this->data['column_status'] = $this->language->get('column_status');
			]]></search>
			<add><![CDATA[
			$this->data['column_approved'] = $this->language->get('column_approved');
			$this->data['column_cpm_customer_account'] = $this->language->get('column_cpm_customer_account');
			]]></add>
		</operation>
		<operation>
			<search position="before"><![CDATA[
			$this->data['filter_status'] = $filter_status;
			]]></search>
			<add><![CDATA[
			$this->data['filter_approved'] = $filter_approved;
			$this->data['filter_cpm_customer_name'] = $filter_cpm_customer_name;
			]]></add>
		</operation>
		<operation>
			<search position="before"><![CDATA[
			$this->data['sort_status'] = $this->url->link('catalog/product', 'token=' . $this->session->data['token'] . '&sort=p.status' . $url, 'SSL');
			]]></search>
			<add><![CDATA[
			$this->data['sort_approved'] = $this->url->link('catalog/product', 'token=' . $this->session->data['token'] . '&sort=p.cpm_approved' . $url, 'SSL');
			$this->data['sort_customer'] = $this->url->link('catalog/product', 'token=' . $this->session->data['token'] . '&sort=c.fullname' . $url, 'SSL');
			]]></add>
		</operation>
		<operation>
			<search position="before" offset="1"><![CDATA[
			$filter_status = $this->request->get['filter_status'];
			]]></search>
			<add><![CDATA[
			if (isset($this->request->get['filter_approved'])) {
				$filter_approved = $this->request->get['filter_approved'];
			} else {
				$filter_approved = null;
			}
			if (isset($this->request->get['filter_cpm_customer_name'])) {
				$filter_cpm_customer_name = $this->request->get['filter_cpm_customer_name'];
			} else {
				$filter_cpm_customer_name = null;
			}
			]]></add>
		</operation>
		<operation>
			<search position="before" offset="1"><![CDATA[
			$url .= '&filter_status=' . $this->request->get['filter_status'];
			]]></search>
			<add><![CDATA[
			if (isset($this->request->get['filter_approved'])) {
				$url .= '&filter_approved=' . $this->request->get['filter_approved'];
			}
			
			if (isset($this->request->get['filter_cpm_customer_name'])) {
				$url .= '&filter_cpm_customer_name=' . urlencode(html_entity_decode($this->request->get['filter_cpm_customer_name'], ENT_QUOTES, 'UTF-8'));
			}		  
			]]></add>
		</operation>
		<operation>
			<search position="before"><![CDATA[
			'filter_status'   => $filter_status,
			]]></search>
			<add><![CDATA[
			'filter_approved'   => $filter_approved,
			'filter_cpm_customer_name'   => $filter_cpm_customer_name,
			]]></add>
		</operation>
		<operation>
			<search position="before"><![CDATA[
			$this->load->model('catalog/manufacturer');
			]]></search>
			<add><![CDATA[
			$this->load->model('sale/customer');
			$data['filter_customer_group_id'] = $this->config->get('cpm_customer_group');
			$data['filter_cpm_enabled'] = 1;
    			$this->data['customers'] = $this->model_sale_customer->getCustomers($data);
			]]></add>
		</operation>
		<operation>
			<search position="before"><![CDATA[
			function autocomplete(
			]]></search>
			<add><![CDATA[
			public function autocompletecpm() {
				$json = array();
			
				$this->load->model('sale/customer');
				
				if (isset($this->request->get['filter_cpm_customer_name'])) {
					$filter_cpm_customer_name = $this->request->get['filter_cpm_customer_name'];
				} else {
					$filter_cpm_customer_name = '';
				}
				
				if (isset($this->request->get['limit'])) {
					$limit = $this->request->get['limit'];	
				} else {
					$limit = 20;	
				}			
							
				$data = array(
					'filter_cpm_customer_name'  => $filter_cpm_customer_name,
					'start'        => 0,
					'limit'        => $limit
				);
				
				$results = $this->model_sale_customer->getCustomers($data);
				
				foreach ($results as $result) {
					$json[] = array(
						'cpm_customer_id' => $result['customer_id'],
						'fullname'       => strip_tags(html_entity_decode($result['fullname'], ENT_QUOTES, 'UTF-8'))
					);	
				}

				$this->response->setOutput(json_encode($json));
			}
			]]></add>
		</operation>
	</file>
	
	<file name="admin/language/english/catalog/product.php">
		<operation>
			<search position="bottom" offset="2"></search>
			<add><![CDATA[
			$_['text_product_approved']         			= 'You have approved %s products!';
			$_['text_product_enabled']           			= 'You have enabled %s products!';
			$_['text_product_disabled']           			= 'You have disabled %s products!';
			$_['error_notchecked']           				= 'No product(s) selected! Please select checkbox(es) next to product(s) and then click action button.';
			$_['button_enable']						= 'Enable';
			$_['button_disable']						= 'Disable';
			$_['text_product_updated_cpm_customer']         = 'You have updated %s products!';
			$_['button_update_cpm_customer']			= 'Update Member';
			]]></add>
		</operation>
		<operation>
			<search position="before"><![CDATA[
			$_['entry_status']           = 'Status:';
			]]></search>
			<add><![CDATA[
			$_['entry_customer']           = 'Member Account:';
			$_['entry_approved']           = 'Approved:';
			]]></add>
		</operation>
		<operation>
			<search position="before"><![CDATA[
			$_['column_status']          = 'Status';
			]]></search>
			<add><![CDATA[
			$_['column_approved']          = 'Approved';
			$_['column_cpm_customer_account']          = 'Member Account';
			]]></add>
		</operation>
	</file>
	
	<file name="admin/model/catalog/product.php">
		<operation>
			<search position="replace"><![CDATA[
			sort_order = '" . (int)$data['sort_order'] . "'
			]]></search>
			<add><![CDATA[
			sort_order = '" . (int)$data['sort_order'] . "', cpm_customer_id = '" . (int)$data['customer_id'] . "', cpm_approved = '" . (int)$data['approved'] . "'
			]]></add>
		</operation>
		<operation>
			<search position="after"><![CDATA[
			$data['status'] = '0';
			]]></search>
			<add><![CDATA[
			$data['approved'] = ($this->config->get('cpm_auto_approve_products') ? '1' : '0');
			]]></add>
		</operation>
		<operation>
			<search position="after"><![CDATA[
			$data = array_merge($data, array('product_store' => $this->getProductStores($product_id)));
			]]></search>
			<add><![CDATA[
			$data['customer_id'] = $data['cpm_customer_id'];
			unset($data['cpm_customer_id']);
			]]></add>
		</operation>
		<operation>
			<search position="after"><![CDATA[
			ON (p.product_id = pd.product_id)";
			]]></search>
			<add><![CDATA[
			// join query to customer table to get CPM customer names associated with products
			if ($this->config->get('cpm_status')) {
				$sql .= " LEFT JOIN (SELECT customer_id, CONCAT(lastname, ', ', firstname) AS fullname FROM " . DB_PREFIX . "customer) AS c ON (p.cpm_customer_id = c.customer_id)";
				$sql .= " LEFT JOIN " . DB_PREFIX . "customer_cpm_account AS cpm ON (p.cpm_customer_id = cpm.customer_id)";
			}
			]]></add>
		</operation>
		<operation>
			<search position="before" offset="1"><![CDATA[
			$sql .= " AND p.status = '" . (int)$data['filter_status'] . "'";
			]]></search>
			<add><![CDATA[
			if (isset($data['filter_approved'])) {
				$sql .= " AND p.cpm_approved = '" . (int)$data['filter_approved'] . "'";
			}
			if (isset($data['filter_member_id'])) {
				$sql .= " AND p.cpm_customer_id = '" . (int)$data['filter_member_id'] . "'";
			}
			if (!empty($data['filter_cpm_customer_name'])) {
				$sql .= " AND LCASE(c.fullname) LIKE '" . $this->db->escape(utf8_strtolower($data['filter_cpm_customer_name'])) . "%'";
			}
			]]></add>
		</operation>
		<operation>
			<search position="after"><![CDATA[
			'p.status',
			]]></search>
			<add><![CDATA[
			'p.cpm_approved',
			'c.fullname',
			]]></add>
		</operation>
		<operation>
			<search position="before"><![CDATA[
			function addProduct($data) {
			]]></search>
			<add><![CDATA[
			public function approveProduct($product_id) {
				$product_info = $this->getProduct($product_id);
				if ($product_info) {
					$this->db->query("UPDATE " . DB_PREFIX . "product SET cpm_approved = '1' WHERE product_id = '" . (int)$product_id . "'");
				}
				$this->cache->delete('product');
			}

			public function enableProduct($product_id) {
				$product_info = $this->getProduct($product_id);
				if ($product_info) {
					$this->db->query("UPDATE " . DB_PREFIX . "product SET status = '1' WHERE product_id = '" . (int)$product_id . "'");
				}
				$this->cache->delete('product');
			}

			public function disableProduct($product_id) {
				$product_info = $this->getProduct($product_id);
				if ($product_info) {
					$this->db->query("UPDATE " . DB_PREFIX . "product SET status = '0' WHERE product_id = '" . (int)$product_id . "'");
				}
				$this->cache->delete('product');
			}
			
			public function updateProductCPMCustomer($product_id, $customer_id) {
				$product_info = $this->getProduct($product_id);
				if ($product_info) {
					$this->db->query("UPDATE " . DB_PREFIX . "product SET cpm_customer_id = '" . (int)$customer_id . "' WHERE product_id = '" . (int)$product_id . "'");
				}
			}
			
			public function getTotalProductsAwaitingApproval($data = array()) {
				$sql = "SELECT COUNT(*) AS total FROM " . DB_PREFIX . "product WHERE cpm_approved = '0'";
				
				if (isset($data['filter_status'])) {
					$sql .=  " AND status = '" . (int)$data['filter_status'] . "'";
				}
				
				if (isset($data['filter_cpm_customer'])) {
					$sql .=  " AND cpm_customer_id > '0'";
				}
				
				if (!empty($data['filter_cpm_customer_id'])) {
					$sql .=  " AND cpm_customer_id = '" . (int)$data['filter_cpm_customer_id'] . "'";
				}
				
				$query = $this->db->query($sql);
				return $query->row['total'];
			}
			]]></add>
		</operation>
	</file>
	
	<file name="admin/view/template/catalog/product_form.tpl">
		<operation>
			<search position="before" offset="1"><![CDATA[
			<td><?php echo $entry_status; ?></td>
			]]></search>
			<add><![CDATA[
			<?php if ($this->config->get('cpm_status')) { ?>
			<tr>
			  <td><?php echo $entry_approved; ?></td>
			  <td><select name="approved">
				  <?php if ($approved) { ?>
				  <option value="1" selected="selected"><?php echo $text_yes; ?></option>
				  <option value="0"><?php echo $text_no; ?></option>
				  <?php } else { ?>
				  <option value="1"><?php echo $text_yes; ?></option>
				  <option value="0" selected="selected"><?php echo $text_no; ?></option>
				  <?php } ?>
				</select></td>
			</tr>
			<?php } ?>
			]]></add>
		</operation>
		<operation>
			<search position="before" offset="1"><![CDATA[
			<td><?php echo $entry_manufacturer; ?></td>
			]]></search>
			<add><![CDATA[
			<?php if ($this->config->get('cpm_status')) { ?>
			<tr>
			  <td><?php echo $entry_customer; ?></td>
			  <td><select name="customer_id">
				  <option value="0" selected="selected"><?php echo $text_none; ?></option>
				  <?php foreach ($customers as $customer) { ?>
				  <?php if ($customer['customer_id'] == $customer_id) { ?>
				  <option value="<?php echo $customer['customer_id']; ?>" selected="selected"><?php echo $customer['fullname']; ?></option>
				  <?php } else { ?>
				  <option value="<?php echo $customer['customer_id']; ?>"><?php echo $customer['fullname']; ?></option>
				  <?php } ?>
				  <?php } ?>
				</select></td>
			</tr>
			<?php } ?>
			]]></add>
		</operation>
	</file>
	
	<file name="admin/view/template/catalog/product_list.tpl">
		<operation>
			<search position="before" offset="1"><![CDATA[
			<td class="left"><?php if ($sort == 'p.status') { ?>
			]]></search>
			<add><![CDATA[
			<?php if ($this->config->get('cpm_status')) { ?>
			<td class="left"><?php if ($sort == 'c.fullname') { ?>
				<a href="<?php echo $sort_customer; ?>" class="<?php echo strtolower($order); ?>"><?php echo $column_cpm_customer_account; ?></a>
				<?php } else { ?>
				<a href="<?php echo $sort_customer; ?>"><?php echo $column_cpm_customer_account; ?></a>
				<?php } ?></td>
			<td class="left"><?php if ($sort == 'p.cpm_approved') { ?>
				<a href="<?php echo $sort_approved; ?>" class="<?php echo strtolower($order); ?>"><?php echo $column_approved; ?></a>
				<?php } else { ?>
				<a href="<?php echo $sort_approved; ?>"><?php echo $column_approved; ?></a>
				<?php } ?></td>
			<?php } ?>
			]]></add>
		</operation>
		<operation>
			<search position="before"><![CDATA[
			<td><select name="filter_status">
			]]></search>
			<add><![CDATA[
			<?php if ($this->config->get('cpm_status')) { ?>
			<td><input type="text" name="filter_cpm_customer_name" value="<?php echo $filter_cpm_customer_name; ?>" /></td>
			<td><select name="filter_approved">
			  <option value="*"></option>
			  <?php if ($filter_approved) { ?>
			  <option value="1" selected="selected"><?php echo $text_yes; ?></option>
			  <?php } else { ?>
			  <option value="1"><?php echo $text_yes; ?></option>
			  <?php } ?>
			  <?php if (!is_null($filter_approved) && !$filter_approved) { ?>
			  <option value="0" selected="selected"><?php echo $text_no; ?></option>
			  <?php } else { ?>
			  <option value="0"><?php echo $text_no; ?></option>
			  <?php } ?>
			</select></td>
			<?php } ?>
			]]></add>
		</operation>
		<operation>
			<search position="before"><![CDATA[
			var filter_status = $('select[name=\'filter_status\']').attr('value');
			]]></search>
			<add><![CDATA[
			var filter_approved = $('select[name=\'filter_approved\']').attr('value');
			
			if (filter_approved != '*') {
				url += '&filter_approved=' + encodeURIComponent(filter_approved);
			}
			var filter_cpm_customer_name = $('input[name=\'filter_cpm_customer_name\']').attr('value');
	
			if (filter_cpm_customer_name) {
				url += '&filter_cpm_customer_name=' + encodeURIComponent(filter_cpm_customer_name);
			}	
			]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[
			<div class="buttons">
			]]></search>
			<add><![CDATA[
			<div class="buttons"><?php if ($this->config->get('cpm_status')) { ?><a onclick="$('form').attr('action', '<?php echo $approve; ?>'); $('form').submit();" class="button" style="background:#CF00FF;"><?php echo $button_approve; ?></a> <a onclick="$('form').attr('action', '<?php echo $enable; ?>'); $('form').submit();" class="button" style="background:#8EC74B;"><?php echo $button_enable; ?></a> <a onclick="$('form').attr('action', '<?php echo $disable; ?>'); $('form').submit();" class="button" style="background:#DC313E;"><?php echo $button_disable; ?></a> <a onclick="$('form').attr('action', '<?php echo $update_cpm_customer; ?>'); $('form').submit();" id="button_update_cpm_customer" class="button" style="background:#545454;"><?php echo $button_update_cpm_customer; ?></a><?php } ?>
			]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[
			<a onclick="filter();" class="button">
			]]></search>
			<add><![CDATA[
			<a onclick="filter();" id="button_filter" class="button">
			]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[
			<td class="left"><?php echo $product['status']; ?></td>
			]]></search>
			<add><![CDATA[
			<?php if ($this->config->get('cpm_status')) { ?>
			<td class="left"><?php echo $product['customer']; ?></td>
			<td class="left" style="color:#FFFFFF;font-weight:bold;background:<?php echo ($product['approved'] === $text_yes) ? '#CF00FF' : '#FFCC00' ?>;"><?php echo $product['approved']; ?></td>
			<?php } ?>
			<td class="left" style="color:#FFF;font-weight:bold;background:<?php echo ($product['status'] === $text_enabled ? '#8EC74B' : '#DC313E'); ?>;"><?php echo $product['status']; ?></td>
			]]></add>
		</operation>
		<operation>
			<search position="before" index="1"><![CDATA[
			</form>
			]]></search>
			<add><![CDATA[
			<input type="hidden" name="cpm_customer_id" value="" />
			]]></add>
		</operation>
		<operation>
			<search position="before"><![CDATA[
			<?php echo $footer; ?>
			]]></search>
			<add><![CDATA[			
			<script type="text/javascript"><!--
			$('input[name=\'filter_cpm_customer_name\']').autocomplete({
				delay: 500,
				source: function(request, response) {
					$.ajax({
						url: 'index.php?route=catalog/product/autocompletecpm&token=<?php echo $token; ?>&filter_cpm_customer_name=' +  encodeURIComponent(request.term),
						dataType: 'json',
						success: function(json) {		
							response($.map(json, function(item) {
								return {
									label: item.fullname,
									value: item.cpm_customer_id
								}
							}));
						}
					});
				}, 
				select: function(event, ui) {
					$('input[name=\'filter_cpm_customer_name\']').val(ui.item.label);
					$('input[name=\'cpm_customer_id\']').val(ui.item.value);
					$('#button_update_cpm_customer').effect("highlight", {color: '#FFCC00'}, 3000);
					$('#button_filter').effect("highlight", {color: '#FFCC00'}, 3000);
									
					return false;
				},
				focus: function(event, ui) {
					return false;
				}
			});
			//--></script>
			]]></add>
		</operation>
	</file>

	<!-- ADMIN DOWNLOAD -->

	<file name="admin/controller/catalog/download.php">
		<operation>
			<search position="after"><![CDATA[
			$this->data['downloads'][] = array(
			]]></search>
			<add><![CDATA[
			'cpm_member'	=> (isset($result['cpm_account_name']) ? $result['cpm_account_name'] : ''),
			'cpm_member_href' => (isset($result['customer_id']) ? $this->url->link('sale/customer/update', 'token=' . $this->session->data['token'] . '&customer_id=' . $result['customer_id'] . $url, 'SSL') : ''),
			]]></add>
		</operation>
		<operation>
			<search position="after"><![CDATA[
			$this->data['column_name']
			]]></search>
			<add><![CDATA[
			if ($this->config->get('cpm_status')) {
				$this->data['column_cpm_member'] = $this->language->get('column_cpm_member');
			}
			]]></add>
		</operation>
		<operation>
			<search position="after"><![CDATA[
			$this->data['sort_name'] = 
			]]></search>
			<add><![CDATA[
			if ($this->config->get('cpm_status')) {
				$this->data['sort_cpm_member'] = $this->url->link('catalog/download', 'token=' . $this->session->data['token'] . '&sort=cpm.cpm_account_name' . $url, 'SSL');
			}
			]]></add>
		</operation>
	</file>
	
	<file name="admin/model/catalog/download.php">
		<operation>
			<search position="replace" offset="2"><![CDATA[
			function getDownloads($data = array()) {
			]]></search>
			<add><![CDATA[
			function getDownloads($data = array()) {
				if ($this->config->get('cpm_status')) {
					$sql = "SELECT * FROM " . DB_PREFIX . "download d LEFT JOIN " . DB_PREFIX . "download_description dd ON (d.download_id = dd.download_id) LEFT JOIN " . DB_PREFIX . "customer_cpm_account cpm ON d.cpm_customer_id = cpm.customer_id WHERE dd.language_id = '" . (int)$this->config->get('config_language_id') . "'";
				} else {
					$sql = "SELECT * FROM " . DB_PREFIX . "download d LEFT JOIN " . DB_PREFIX . "download_description dd ON (d.download_id = dd.download_id) WHERE dd.language_id = '" . (int)$this->config->get('config_language_id') . "'";
				}
			]]></add>
		</operation>
		<operation>
			<search position="after"><![CDATA[
			$sort_data = array(
			]]></search>
			<add><![CDATA[
			'cpm.cpm_account_name',
			]]></add>
		</operation>
	</file>
		
	<file name="admin/language/english/catalog/download.php">
		<operation>
			<search position="bottom" offset="2"></search>
			<add><![CDATA[
			$_['column_cpm_member']		= 'Member';
			]]></add>
		</operation>
	</file>
		
	<file name="admin/view/template/catalog/download_list.tpl">
		<operation>
			<search position="before"><![CDATA[
			<td class="right"><?php if ($sort == 'd.remaining') { ?>
			]]></search>
			<add><![CDATA[
			<?php if ($this->config->get('cpm_status')) { ?>
			<td class="left"><?php if ($sort == 'cpm.cpm_account_name') { ?>
				<a href="<?php echo $sort_cpm_member; ?>" class="<?php echo strtolower($order); ?>"><?php echo $column_cpm_member; ?></a>
				<?php } else { ?>
				<a href="<?php echo $sort_cpm_member; ?>"><?php echo $column_cpm_member; ?></a>
				<?php } ?></td>
			<?php } ?>
			]]></add>
		</operation>
		<operation>
			<search position="after"><![CDATA[
			<td class="left"><?php echo $download['name']; ?></td>
			]]></search>
			<add><![CDATA[
			<?php if ($this->config->get('cpm_status')) { ?><td class="left"><a href="<?php echo $download['cpm_member_href']; ?>"><?php echo $download['cpm_member']; ?></a></td><?php } ?>
			]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[
			<td class="center" colspan="6">
			]]></search>
			<add><![CDATA[
			<td class="center" colspan="7">
			]]></add>
		</operation>
	</file>

	<!-- ADMIN ORDER -->
	
	<file name="admin/controller/sale/order.php">
		<operation>
			<search position="after"><![CDATA[
			$result['mask'],
			]]></search>
			<add><![CDATA[
			// 'href'  => '../download/' . $result['filename'], // old direct link method (insecure)
			'href'  => $this->url->link('sale/order/digital_download', 'token=' . $this->session->data['token'] . '&order_download_id=' . $result['order_download_id'], 'SSL'),
			]]></add>
		</operation>
		<operation>
			<search position="before"><![CDATA[
			function download()
			]]></search>
			<add><![CDATA[
			public function digital_download() {
				$this->load->model('sale/order');
				
				if (isset($this->request->get['order_download_id'])) {
					$order_download_id = $this->request->get['order_download_id'];
				} else {
					$order_download_id = 0;
				}
				
				$download_info = $this->model_sale_order->getDigitalDownload($order_download_id);
				
				if ($download_info) {
					$file = DIR_DOWNLOAD . $download_info['filename'];
					$mask = basename($download_info['mask']);

					if (!headers_sent()) {
						if (file_exists($file)) {
							header('Content-Type: application/octet-stream');
							header('Content-Description: File Transfer');
							header('Content-Disposition: attachment; filename="' . ($mask ? $mask : basename($file)) . '"');
							header('Content-Transfer-Encoding: binary');
							header('Expires: 0');
							header('Cache-Control: must-revalidate, post-check=0, pre-check=0');
							header('Pragma: public');
							header('Content-Length: ' . filesize($file));
							
							readfile($file, 'rb');
														
							exit;
						} else {
							exit('Error: Could not find file ' . $file . '!');
						}
					} else {
						exit('Error: Headers already sent out!');
					}
				} else {
					$this->load->language('error/not_found');

					$this->document->setTitle($this->language->get('heading_title'));

					$this->data['heading_title'] = $this->language->get('heading_title');

					$this->data['text_not_found'] = $this->language->get('text_not_found');

					$this->data['breadcrumbs'] = array();

					$this->data['breadcrumbs'][] = array(
						'text'      => $this->language->get('text_home'),
						'href'      => $this->url->link('common/home', 'token=' . $this->session->data['token'], 'SSL'),
						'separator' => false
					);

					$this->data['breadcrumbs'][] = array(
						'text'      => $this->language->get('heading_title'),
						'href'      => $this->url->link('error/not_found', 'token=' . $this->session->data['token'], 'SSL'),
						'separator' => ' :: '
					);
				
					$this->template = 'error/not_found.tpl';
					$this->children = array(
						'common/header',
						'common/footer'
					);
				
					$this->response->setOutput($this->render());
				}	
			}
			]]></add>
		</operation>
		<operation>
			<search position="after"><![CDATA[
			$this->data['column_total']
			]]></search>
			<add><![CDATA[
			if ($this->config->get('cpm_status')) {
				$this->data['column_image'] = $this->language->get('column_image');
				$this->data['column_cpm_member'] = $this->language->get('column_cpm_member');
				$this->data['column_tax'] = $this->language->get('column_tax');
				$this->data['column_cpm_commission'] = $this->language->get('column_cpm_commission');
				$this->data['text_cpm_commission'] = $this->language->get('text_cpm_commission');
			}
			]]></add>
		</operation>
		<operation>
			<search position="after" index="1"><![CDATA[
			$this->data['orders'][] = array(
			]]></search>
			<add><![CDATA[
			'cpm_commission'      => (isset($result['cpm_commission']) ? $this->currency->format($result['cpm_commission'], $result['currency_code'], $result['currency_value']) : ''),
			]]></add>
		</operation>
		<operation>
			<search position="after" index="2"><![CDATA[
			$this->data['orders'][] = array(
			]]></search>
			<add><![CDATA[
			'cpm_commission'         => (isset($order_info['cpm_commission']) ? $order_info['cpm_commission'] : ''),
			]]></add>
		</operation>
		<operation>
			<search position="after"><![CDATA[
			$this->data['total']
			]]></search>
			<add><![CDATA[
			$this->data['cpm_commission'] = $this->currency->format($order_info['cpm_commission'], $order_info['currency_code'], $order_info['currency_value']);
			]]></add>
		</operation>
		<operation>
			<search position="before" index="1,3"><![CDATA[
			foreach ($products as $product) {
			]]></search>
			<add><![CDATA[
			if ($this->config->get('cpm_status')) {
				$this->load->model('tool/image');
			}
			]]></add>
		</operation>
		<operation>
			<search position="before"><![CDATA[
			foreach ($order_products as $order_product) {
			]]></search>
			<add><![CDATA[
			if ($this->config->get('cpm_status')) {
				$this->load->model('tool/image');
			}
			]]></add>
		</operation>
		<operation>
			<search position="after" index="1,3"><![CDATA[
			foreach ($products as $product) {
			]]></search>
			<add><![CDATA[
			if ($product['image'] && file_exists(DIR_IMAGE . $product['image'])) {
					$image_thumb = $this->model_tool_image->resize($product['image'], 40, 40);
				} else {
					$image_thumb = $this->model_tool_image->resize('no_image.jpg', 40, 40);
				}
			]]></add>
		</operation>
		<operation>
			<search position="after"><![CDATA[
			foreach ($order_products as $order_product) {
			]]></search>
			<add><![CDATA[
			if ($order_product['image'] && file_exists(DIR_IMAGE . $order_product['image'])) {
					$image_thumb = $this->model_tool_image->resize($order_product['image'], 40, 40);
				} else {
					$image_thumb = $this->model_tool_image->resize('no_image.jpg', 40, 40);
				}
			]]></add>
		</operation>
		<operation>
			<search position="after"><![CDATA[
			$this->data['products'][] = array(
			]]></search>
			<add><![CDATA[
			'cpm_customer_id'             => (isset($product['cpm_customer_id']) ? $product['cpm_customer_id'] : ''),
			'cpm_member'             	=> (isset($product['cpm_account_name']) ? $product['cpm_account_name'] : ''),
			'image'             			=> (isset($product['image']) ? $product['image'] : ''),
			'image_thumb' 			=> $image_thumb,
			'cpm_commission'             => (isset($product['commission']) ? $this->currency->format($product['commission'], $order_info['currency_code'], $order_info['currency_value']) : ''),
			]]></add>
		</operation>
		<operation>
			<search position="after"><![CDATA[
			$product_data[] = array(
			]]></search>
			<add><![CDATA[
			'cpm_customer_id'             => (isset($product['cpm_customer_id']) ? $product['cpm_customer_id'] : ''),
			'cpm_member'             	=> (isset($product['cpm_account_name']) ? $product['cpm_account_name'] : ''),
			'image'             			=> (isset($product['image']) ? $product['image'] : ''),
			'image_thumb' 			=> $image_thumb,
			'cpm_commission'             => (isset($product['commission']) ? $this->currency->format($product['commission'], $order_info['currency_code'], $order_info['currency_value']) : ''),
			]]></add>
		</operation>
		<operation>
			<search position="after"><![CDATA[
			$this->data['order_products'][] = array(
			]]></search>
			<add><![CDATA[
			'cpm_customer_id'             => (isset($order_product['cpm_customer_id']) ? $order_product['cpm_customer_id'] : ''),
			'cpm_member'             	=> (isset($order_product['cpm_account_name']) ? $order_product['cpm_account_name'] : ''),
			'image'             			=> (isset($order_product['image']) ? $order_product['image'] : ''),
			'image_thumb' 			=> $image_thumb,
			'cpm_commission'             => (isset($order_product['commission']) ? $order_product['commission'] : ''),
			]]></add>
		</operation>
		<operation>
			<search position="after"><![CDATA[
			$this->data['column_comment']
			]]></search>
			<add><![CDATA[
			$this->data['column_member'] = $this->language->get('column_member');
			]]></add>
		</operation>
		<operation>
			<search position="after"><![CDATA[
			nl2br($result['comment'])
			]]></search>
			<add><![CDATA[
			'member'     => $result['member'] ? $result['member'] : $this->language->get('text_admin'),
			]]></add>
		</operation>
	</file>
		
	<file name="admin/language/english/sale/order.php">
		<operation>
			<search position="bottom" offset="2"></search>
			<add><![CDATA[
			// CPM
			$_['column_image']          			= 'Image';
			$_['column_cpm_member']		= 'Member (CPM)';
			$_['column_tax']                            	= 'Sales Tax';
			$_['column_cpm_commission']		= 'Commission (CPM)';
			$_['text_cpm_commission']		= 'Commission (CPM)';
			$_['column_member']         		= 'Member';
			$_['text_admin']            			= 'Store Admin';
			]]></add>
		</operation>
	</file>
		
	<file name="admin/model/sale/order.php">
		<operation>
			<search position="before"><![CDATA[
			function getOrderDownloads(
			]]></search>
			<add><![CDATA[
			public function getDigitalDownload($order_download_id) {
				$query = $this->db->query("SELECT * FROM " . DB_PREFIX . "order_download WHERE  order_download_id = '" . (int)$order_download_id . "'");
				return $query->row;
			}
			]]></add>
		</operation>
		<operation>
			<search position="replace" offset="2"><![CDATA[
			function getOrder($order_id) {
			]]></search>
			<add><![CDATA[
			function getOrder($order_id) {
				if ($this->config->get('cpm_status')) {
					$order_query = $this->db->query("SELECT *, (SELECT SUM(op.commission) FROM " . DB_PREFIX . "order_product op WHERE op.order_id = o.order_id) AS cpm_commission, (SELECT CONCAT(c.firstname, ' ', c.lastname) FROM " . DB_PREFIX . "customer c WHERE c.customer_id = o.customer_id) AS customer FROM `" . DB_PREFIX . "order` o WHERE o.order_id = '" . (int)$order_id . "'");
				} else {
					$order_query = $this->db->query("SELECT *, (SELECT CONCAT(c.firstname, ' ', c.lastname) FROM " . DB_PREFIX . "customer c WHERE c.customer_id = o.customer_id) AS customer FROM `" . DB_PREFIX . "order` o WHERE o.order_id = '" . (int)$order_id . "'");
				}
			]]></add>
		</operation>
		<operation>
			<search position="after"><![CDATA[
			$order_query->row['total'],
			]]></search>
			<add><![CDATA[
			'cpm_commission'                   => $order_query->row['cpm_commission'],
			]]></add>
		</operation>
		<operation>
			<search position="replace" offset="2"><![CDATA[
			function getOrders($data = array()) {
			]]></search>
			<add><![CDATA[
			function getOrders($data = array()) {
				if (($this->config->get('cpm_status')) && $this->config->get('cpm_release')) {
					$sql = "SELECT o.order_id, CONCAT(o.firstname, ' ', o.lastname) AS customer, (SELECT SUM(op.commission) FROM " . DB_PREFIX . "order_product op WHERE op.order_id = o.order_id) AS cpm_commission, (SELECT os.name FROM " . DB_PREFIX . "order_status os WHERE os.order_status_id = o.order_status_id AND os.language_id = '" . (int)$this->config->get('config_language_id') . "') AS status, o.total, o.currency_code, o.currency_value, o.date_added, o.date_modified FROM `" . DB_PREFIX . "order` o";
				} else {
					$sql = "SELECT o.order_id, CONCAT(o.firstname, ' ', o.lastname) AS customer, (SELECT os.name FROM " . DB_PREFIX . "order_status os WHERE os.order_status_id = o.order_status_id AND os.language_id = '" . (int)$this->config->get('config_language_id') . "') AS status, o.total, o.currency_code, o.currency_value, o.date_added, o.date_modified FROM `" . DB_PREFIX . "order` o";
				}
			]]></add>
		</operation>
		<operation>
			<search position="replace" offset="2"><![CDATA[
			function getOrderProducts($order_id) {
			]]></search>
			<add><![CDATA[
			function getOrderProducts($order_id) {
				if ($this->config->get('cpm_status')) {
					$query = $this->db->query("SELECT * FROM " . DB_PREFIX . "order_product op LEFT JOIN " . DB_PREFIX . "customer_cpm_account cpm ON op.cpm_customer_id = cpm.customer_id WHERE order_id = '" . (int)$order_id . "'");
				} else {
					$query = $this->db->query("SELECT * FROM " . DB_PREFIX . "order_product WHERE order_id = '" . (int)$order_id . "'");
				}
			]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[
			, product_id = '" . (int)$order_product['product_id'] . "'
			]]></search>
			<add><![CDATA[
			, product_id = '" . (int)$order_product['product_id'] . "', cpm_customer_id = '" . (int)$order_product['cpm_customer_id'] . "', image = '" . $this->db->escape($order_product['image']) . "', commission = '" . (float)$order_product['cpm_commission'] . "'
			]]></add>
		</operation>
		<operation>
			<search position="before"><![CDATA[
			$query = $this->db->query("SELECT oh.date_added
			]]></search>
			<add><![CDATA[
			if ($this->config->get('cpm_status')) {
				$query = $this->db->query("SELECT cpm.cpm_account_name AS member, oh.date_added, os.name AS status, oh.comment, oh.notify FROM " . DB_PREFIX . "order_history oh LEFT JOIN " . DB_PREFIX . "order_status os ON oh.order_status_id = os.order_status_id LEFT JOIN " . DB_PREFIX . "customer_cpm_account cpm ON oh.cpm_customer_id = cpm.customer_id WHERE oh.order_id = '" . (int)$order_id . "' AND os.language_id = '" . (int)$this->config->get('config_language_id') . "' ORDER BY oh.date_added ASC LIMIT " . (int)$start . "," . (int)$limit);
			} else {
			]]></add>
		</operation>
		<operation>
			<search position="after"><![CDATA[
			$query = $this->db->query("SELECT oh.date_added
			]]></search>
			<add><![CDATA[
			}
			]]></add>
		</operation>
	</file>
		
	<file name="admin/view/template/sale/order_list.tpl">
		<operation>
			<search position="after" index="2" offset="1"><![CDATA[
			<?php echo $column_total; ?>
			]]></search>
			<add><![CDATA[
			<?php if ($this->config->get('cpm_status')) { ?><td class="right"><?php echo $column_cpm_commission; ?></td><?php } ?>
			]]></add>
		</operation>
		<operation>
			<search position="after"><![CDATA[
			<?php echo $filter_total; ?>
			]]></search>
			<add><![CDATA[
			<?php if ($this->config->get('cpm_status')) { ?><td>&nbsp;</td><?php } ?>
			]]></add>
		</operation>
		<operation>
			<search position="after"><![CDATA[
			<?php echo $order['total']; ?>
			]]></search>
			<add><![CDATA[
			<?php if ($this->config->get('cpm_status')) { ?><td class="right"><?php echo $order['cpm_commission']; ?></td><?php } ?>
			]]></add>
		</operation>
	</file>
		
	<file name="admin/view/template/sale/order_info.tpl">
		<operation>
			<search position="replace"><![CDATA[
			<?php echo $download['filename']; ?>
			]]></search>
			<add><![CDATA[
			<?php if ($this->config->get('cpm_status')) { ?>
				<a href="<?php echo $download['href']; ?>"><?php echo $download['filename']; ?></a>
			<?php } else { ?>
				<?php echo $download['filename']; ?>
			<?php } ?>
			]]></add>
		</operation>
		<operation>
			<search position="before" offset="1"><![CDATA[
			<?php echo $text_total; ?>
			]]></search>
			<add><![CDATA[
			<?php if ($this->config->get('cpm_status')) { ?>
			  <tr>
			    <td><?php echo $text_cpm_commission; ?></td>
			    <td><?php echo $cpm_commission; ?></td>
			  </tr>
			<?php } ?>
			]]></add>
		</operation>
		<operation>
			<search position="before"><![CDATA[
			<?php echo $column_product; ?>
			]]></search>
			<add><![CDATA[
			<?php if ($this->config->get('cpm_status')) { ?><td class="left"><?php echo $column_image; ?></td><?php } ?>
			]]></add>
		</operation>
		<operation>
			<search position="after"><![CDATA[
			<?php echo $column_model; ?>
			]]></search>
			<add><![CDATA[
			<?php if ($this->config->get('cpm_status')) { ?><td class="left"><?php echo $column_cpm_member; ?></td><?php } ?>
			]]></add>
		</operation>
		<operation>
			<search position="before"><![CDATA[
			<?php echo $column_total; ?>
			]]></search>
			<add><![CDATA[
			<?php if ($this->config->get('cpm_status')) { ?><td class="right"><?php echo $column_cpm_commission; ?></td><?php } ?>
			]]></add>
		</operation>
		<operation>
			<search position="before"><![CDATA[
			<?php echo $product['name']; ?>
			]]></search>
			<add><![CDATA[
			<?php if ($this->config->get('cpm_status')) { ?><td class="center"><img src="<?php echo $product['image_thumb']; ?>" alt="<?php echo $product['name']; ?>" style="padding: 1px; border: 1px solid #DDDDDD;" /></td><?php } ?>
			]]></add>
		</operation>
		<operation>
			<search position="after"><![CDATA[
			<?php echo $product['model']; ?>
			]]></search>
			<add><![CDATA[
			<?php if ($this->config->get('cpm_status')) { ?><td class="left"><?php echo $product['cpm_member']; ?></td><?php } ?>
			]]></add>
		</operation>
		<operation>
			<search position="before"><![CDATA[
			<?php echo $product['total']; ?>
			]]></search>
			<add><![CDATA[
			<?php if ($this->config->get('cpm_status')) { ?><td class="right"><?php echo $product['cpm_commission']; ?></td><?php } ?>
			]]></add>
		</operation>
		<operation>
			<search position="replace" offset="8"><![CDATA[
			<?php foreach ($vouchers as $voucher) { ?>
			]]></search>
			<add><![CDATA[
			<?php foreach ($vouchers as $voucher) { ?>
			    <tr>
			      <?php if ($this->config->get('cpm_status')) { ?><td class="center"></td><?php } ?>
			      <td class="left"><a href="<?php echo $voucher['href']; ?>"><?php echo $voucher['description']; ?></a></td>
			      <td class="left"></td>
			      <?php if ($this->config->get('cpm_status')) { ?><td class="left"></td><?php } ?>
			      <td class="right">1</td>
			      <td class="right"><?php echo $voucher['amount']; ?></td>
			      <?php if ($this->config->get('cpm_status')) { ?><td class="right"></td><?php } ?>
			      <td class="right"><?php echo $voucher['amount']; ?></td>
			    </tr>
			<?php } ?>
			]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[
			colspan="4"
			]]></search>
			<add><![CDATA[
			colspan="<?php echo (($this->config->get('cpm_status')) ? '7' : '4'); ?>"
			]]></add>
		</operation>
	</file>
		
	<file name="admin/view/template/sale/order_history.tpl">
		<operation>
			<search position="after"><![CDATA[
			<?php echo $column_comment; ?>
			]]></search>
			<add><![CDATA[
			<td class="left"><b><?php echo $column_member; ?></b></td>
			]]></add>
		</operation>
		<operation>
			<search position="after"><![CDATA[
			<?php echo $history['comment']; ?>
			]]></search>
			<add><![CDATA[
			<td class="left"><?php echo $history['member']; ?></td>
			]]></add>
		</operation>
	</file>
		
	<file name="admin/view/template/sale/order_form.tpl">
		<operation>
			<search position="before" index="1,3"><![CDATA[
			<?php echo $column_product; ?>
			]]></search>
			<add><![CDATA[
			<?php if ($this->config->get('cpm_status')) { ?><td class="center"><?php echo $column_image; ?></td><?php } ?>
			]]></add>
		</operation>
		<operation>
			<search position="after" index="1,3"><![CDATA[
			<td class="left"><?php echo $column_model; ?></td>
			]]></search>
			<add><![CDATA[
			<?php if ($this->config->get('cpm_status')) { ?><td class="left"><?php echo $column_cpm_member; ?></td><?php } ?>
			]]></add>
		</operation>
		<operation>
			<search position="before" index="1,3"><![CDATA[
			<td class="right"><?php echo $column_total; ?></td>
			]]></search>
			<add><![CDATA[
			<?php if ($this->config->get('cpm_status')) { ?><td class="right"><?php echo $column_cpm_commission; ?></td><?php } ?>			
			]]></add>
		</operation>
		<operation>
			<search position="before"><![CDATA[
			<td class="left"><?php echo $order_product['name']; ?>
			]]></search>
			<add><![CDATA[
			<?php if ($this->config->get('cpm_status')) { ?><td class="center"><img src="<?php echo $order_product['image_thumb']; ?>" alt="<?php echo $order_product['name']; ?>" style="padding: 1px; border: 1px solid #DDDDDD;" /></td><?php } ?>
			]]></add>
		</operation>
		<operation>
			<search position="after" index="1"><![CDATA[
			<?php echo $order_product['model']; ?>
			]]></search>
			<add><![CDATA[
			<?php if ($this->config->get('cpm_status')) { ?>				
				<td class="left"><?php echo $order_product['cpm_member']; ?>
				<input type="hidden" name="order_product[<?php echo $product_row; ?>][cpm_customer_id]" value="<?php echo $order_product['cpm_customer_id']; ?>" /></td>
			<?php } ?>			
			]]></add>
		</operation>
		<operation>
			<search position="after" index="3"><![CDATA[
			<?php echo $order_product['model']; ?>
			]]></search>
			<add><![CDATA[
			<?php if ($this->config->get('cpm_status')) { ?><td class="left"><?php echo $order_product['cpm_member']; ?></td>
			<?php } ?>			
			]]></add>
		</operation>
		<operation>
			<search position="before" index="1"><![CDATA[
			<?php echo $order_product['total']; ?>
			]]></search>
			<add><![CDATA[
			<?php if ($this->config->get('cpm_status')) { ?>								
				<td class="right"><?php echo $order_product['cpm_commission']; ?>
			        <input type="hidden" name="order_product[<?php echo $product_row; ?>][cpm_commission]" value="<?php echo $order_product['cpm_commission']; ?>" />
			        <input type="hidden" name="order_product[<?php echo $product_row; ?>][image]" value="<?php echo $order_product['image']; ?>" /></td>
			<?php } ?>			  
			]]></add>
		</operation>
		<operation>
			<search position="before" index="3"><![CDATA[
			<?php echo $order_product['total']; ?>
			]]></search>
			<add><![CDATA[
			<?php if ($this->config->get('cpm_status')) { ?><td class="right"><?php echo $order_product['cpm_commission']; ?><?php } ?>			  
			]]></add>
		</operation>
		<operation>
			<search position="replace" index="1"><![CDATA[
			colspan="4"
			]]></search>
			<add><![CDATA[
			colspan="<?php echo (($this->config->get('cpm_status')) ? '7' : '4'); ?>"
			]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[
			html += '  <td class="right" colspan="4"><input type="hidden" name="order_total[' + total_row + '][order_total_id]" value="" /><input type="hidden" name="order_total[' + total_row + '][code]" value="' + total['code'] + '" /><input type="hidden" name="order_total[' + total_row + '][title]" value="' + total['title'] + '" /><input type="hidden" name="order_total[' + total_row + '][text]" value="' + total['text'] + '" /><input type="hidden" name="order_total[' + total_row + '][value]" value="' + total['value'] + '" /><input type="hidden" name="order_total[' + total_row + '][sort_order]" value="' + total['sort_order'] + '" />' + total['title'] + ':</td>';
			]]></search>
			<add><![CDATA[
			html += '  <td class="right" colspan="<?php echo (($this->config->get('cpm_status')) ? '7' : '4'); ?>"><input type="hidden" name="order_total[' + total_row + '][order_total_id]" value="" /><input type="hidden" name="order_total[' + total_row + '][code]" value="' + total['code'] + '" /><input type="hidden" name="order_total[' + total_row + '][title]" value="' + total['title'] + '" /><input type="hidden" name="order_total[' + total_row + '][text]" value="' + total['text'] + '" /><input type="hidden" name="order_total[' + total_row + '][value]" value="' + total['value'] + '" /><input type="hidden" name="order_total[' + total_row + '][sort_order]" value="' + total['sort_order'] + '" />' + total['title'] + ':</td>';
			]]></add>
		</operation>
		<operation>
			<search position="before" index="1"><![CDATA[
			html += '  <td class="left">' + product['name']
			]]></search>
			<add><![CDATA[
			html += '  <td class="center"><img src="' + product['image_display'] + '" alt="' + product['name'] + '" style="padding: 1px; border: 1px solid #DDDDDD;" /><input type="hidden" name="order_product[' + product_row + '][image]" value="' + product['image_file'] + '" /></td>';			
			]]></add>
		</operation>
		<operation>
			<search position="after" index="1"><![CDATA[
			html += '  <td class="left">' + product['model'] +
			]]></search>
			<add><![CDATA[
			html += '  <td class="left">' + product['cpm_member'] + '<input type="hidden" name="order_product[' + product_row + '][cpm_customer_id]" value="' + product['cpm_customer_id'] + '" /></td>';			
			]]></add>
		</operation>
		<operation>
			<search position="before" index="1"><![CDATA[
			html += '  <td class="right">' + product['total'] +
			]]></search>
			<add><![CDATA[
			html += '  <td class="right">' + product['cpm_commission'] + '<input type="hidden" name="order_product[' + product_row + '][cpm_commission]" value="' + product['cpm_commission'] + '" /></td>';
			]]></add>
		</operation>
		<operation>
			<search position="before" index="2"><![CDATA[
			html += '  <td class="left">' + product['name']
			]]></search>
			<add><![CDATA[
			html += '  <td class="center"><img src="' + product['image_display'] + '" alt="' + product['name'] + '" style="padding: 1px; border: 1px solid #DDDDDD;" /></td>';			
			]]></add>
		</operation>
		<operation>
			<search position="after" index="2"><![CDATA[
			html += '  <td class="left">' + product['model'] +
			]]></search>
			<add><![CDATA[
			html += '  <td class="left">' + product['cpm_member'] + '</td>';			
			]]></add>
		</operation>
		<operation>
			<search position="before" index="2"><![CDATA[
			html += '  <td class="right">' + product['total'] +
			]]></search>
			<add><![CDATA[
			html += '  <td class="right">' + product['cpm_commission'] + '</td>';
			]]></add>
		</operation>
	</file>
	
	<!-- END ADMIN -->
	<!-- START FRONT-END -->	

	<!-- FRONT-END HEADER & FOOTER -->

	<file name="catalog/language/english/common/header.php">
		<operation>
			<search position="bottom" offset="2"></search>
			<add><![CDATA[
			$_['text_members']		= 'Members';
			]]></add>
		</operation>
	</file>
	
	<file name="catalog/controller/common/header.php">
		<operation>
			<search position="after"><![CDATA[
			$this->data['text_checkout']
			]]></search>			
			<add><![CDATA[
			// Members List (CPM)
			$this->data['text_members'] = $this->language->get('text_members');
			// uncomment to use name from CPM Settings instead of language file
			/*
			$language_id = (int)$this->config->get('config_language_id');
			$members_list_description = $this->config->get('cpm_members_list_description');
			$this->data['text_members'] = $members_list_description[$language_id]['name'];
			*/
			$this->data['members'] = $this->url->link('product/member');
			]]></add>
		</operation>
	</file>
	
	<file name="catalog/view/theme/default/template/common/header.tpl">
		<operation>
			<search position="before"><![CDATA[
			 <?php foreach ($categories as $category) { ?>
			]]></search>
			<add><![CDATA[
			<?php if ($this->config->get('cpm_status') && $this->config->get('cpm_member_pages') && $this->config->get('cpm_members_nav_menu')) { ?>
			<li><a href="<?php echo $members; ?>"><?php echo $text_members; ?></a></li>
			<?php } ?>
			]]></add>
		</operation>
	</file>

	<file name="catalog/controller/common/footer.php">
		<operation>
			<search position="after"><![CDATA[
			data['manufacturer']
			]]></search>
			<add><![CDATA[
			$this->data['member'] = $this->url->link('product/member');
			]]></add>
		</operation>
		<operation>
			<search position="after"><![CDATA[
			data['text_manufacturer']
			]]></search>
			<add><![CDATA[
			$this->data['text_member'] = $this->language->get('text_member');
			]]></add>
		</operation>
	</file>
	
	<file name="catalog/language/english/common/footer.php">
		<operation>
			<search position="bottom" offset="2"></search>
			<add><![CDATA[
			$_['text_member'] = 'Members';
			]]></add>
		</operation>
	</file>
	
	<file name="catalog/view/theme/default/template/common/footer.tpl">
		<operation>
			<search position="after"><![CDATA[
			$manufacturer
			]]></search>
			<add><![CDATA[
			<?php if ($this->config->get('cpm_status') && $this->config->get('cpm_member_pages')) { ?>
      			<li><a href="<?php echo $member; ?>"><?php echo $text_member; ?></a></li>
			<?php } ?>
			]]></add>
		</operation>
	</file>

	<!-- FRONT-END REGISTRATION -->
	
	<file name="catalog/controller/account/register.php">
		<operation>
			<search position="after"><![CDATA[
			data['text_account_already']
			]]></search>
			<add><![CDATA[
			$this->data['text_register_cpm_account'] = sprintf($this->language->get('text_register_cpm_account'), $this->url->link('account/register_cpm', '', 'SSL'));
			]]></add>
		</operation>
		<operation>
			<search position="after" offset="2"><![CDATA[
			if ($this->customer->isLogged()) {
			]]></search>
			<add><![CDATA[
			elseif ($this->config->get('cpm_status') && $this->config->get('cpm_registration')) {
				$this->redirect($this->url->link('account/register_landing', '', 'SSL'));
			}
			]]></add>
		</operation>
	</file>
	
	<file name="catalog/language/english/account/register.php">
		<operation>
			<search position="bottom" offset="2"></search>
			<add><![CDATA[
			$_['text_register_cpm_account'] = 'To apply for a membership, please submit the <a href="%s">membership account registration form</a>.';
			]]></add>
		</operation>
	</file>
	
	<file name="catalog/view/theme/default/template/account/register.tpl">
		<operation>
			<search position="after"><![CDATA[
			$text_account_already
			]]></search>
			<add><![CDATA[
			<?php if ($this->config->get('cpm_status') && $this->config->get('cpm_registration')) { ?><p><?php echo $text_register_cpm_account; ?></p><?php } ?>
			]]></add>
		</operation>
	</file>

	<file name="catalog/controller/account/success.php">
		<operation>
			<search position="replace"><![CDATA[
			$this->language->get('text_message'),
			]]></search>
			<add><![CDATA[
			($this->customer->getCustomerProductManager() ? $this->language->get('text_message_cpm') : $this->language->get('text_message')),
			]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[
			$this->language->get('text_approval'),
			]]></search>
			<add><![CDATA[
			($this->customer->getCustomerProductManager() ? $this->language->get('text_approval_cpm') : $this->language->get('text_approval')),
			]]></add>
		</operation>
	</file>

	<file name="catalog/language/english/account/success.php">
		<operation>
			<search position="bottom" offset="2"></search>
			<add><![CDATA[
			$_['text_message_cpm']  = '<p>Congratulations! Your new website membership account has been successfully created!</p> <p>You can now take advantage of member privileges to enhance your online shopping experience with us.</p> <p>If you have ANY questions about the operation of this online shop, please email the store owner.</p> <p>A confirmation has been sent to the provided email address. If you have not received it within the hour, please <a href="%s">contact us</a>.</p>';
			$_['text_approval_cpm'] = '<p>Thank you for registering a membership account with %s!</p><p>You will be notified by email once your account has been activated by the store owner.</p><p>If you have ANY questions about the operation of this online shop, please <a href="%s">contact the store owner</a>.</p>';
			]]></add>
		</operation>
	</file>

	<file name="catalog/language/english/mail/customer.php">
		<operation>
			<search position="bottom" offset="2"></search>
			<add><![CDATA[
			$_['text_welcome_cpm']  = 'Welcome and thank you for registering a membership account with %s!';
			$_['text_services_cpm'] = 'You now can take advantage of all the additional features of being a member, such as having access to your our Product Listing Manager with which you will be able to create and manage your own Product Listings!';
			]]></add>
		</operation>
	</file>

	<!-- FRONT-END SEO URLs -->

	<file name="catalog/controller/common/seo_url.php">
		<operation>
			<search position="before"><![CDATA[
			if ($url[0] == 'product_id') {
			]]></search>
			<add><![CDATA[
			if ($url[0] == 'product/member') {
				$this->request->get['route'] = 'product/member';
			}
			]]></add>
		</operation>
		<operation>
			<search position="before"><![CDATA[
			if ($url[0] == 'manufacturer_id') {
			]]></search>
			<add><![CDATA[
			if ($url[0] == 'member_id') {
				$this->request->get['member_id'] = $url[1];
			}
			]]></add>
		</operation>
		<operation>
			<search position="before"><![CDATA[
			} elseif (isset($this->request->get['manufacturer_id'])) {
			]]></search>
			<add><![CDATA[
			} elseif (isset($this->request->get['member_id'])) {
				$this->request->get['route'] = 'product/member/info';
			]]></add>
		</operation>
		<operation>
			<search position="before"><![CDATA[
			} elseif ($key == 'path'
			]]></search>
			<add><![CDATA[
			} elseif ($data['route'] == 'product/member') {
				$query = $this->db->query("SELECT * FROM " . DB_PREFIX . "url_alias WHERE `query` = '" . $this->db->escape($data['route']) . "'");
				if ($query->num_rows) {
					$url .= '/' . $query->row['keyword'];
					unset($data[$key]);
				}
			} elseif ($data['route'] == 'product/member/info' && $key == 'member_id') {
				$query = $this->db->query("SELECT * FROM " . DB_PREFIX . "url_alias WHERE `query` = '" . $this->db->escape($key . '=' . (int)$value) . "'");
				if ($query->num_rows) {
					$url .= '/' . $query->row['keyword'];
					unset($data[$key]);
				}
			]]></add>
		</operation>
	</file>

	<!-- FRONT-END ACCOUNT -->

	<file name="catalog/controller/account/account.php">
		<operation>
			<search position="after"><![CDATA[
			$this->data['heading_title'] = $this->language->get('heading_title');
			]]></search>
			<add><![CDATA[
			if (($this->config->get('cpm_status')) && ($this->customer->getCustomerProductManager())) {
				$this->data['text_my_products'] = $this->language->get('text_my_products');
				$this->data['text_product'] = $this->language->get('text_product');
				$this->data['text_product_images'] = $this->language->get('text_product_images');
				$this->data['text_product_download'] = $this->language->get('text_product_download');
				$this->data['text_my_sales'] = $this->language->get('text_my_sales');				
				$this->data['product'] = 'href="' . $this->url->link('account/product', '', 'SSL') . '"';
				$this->data['product_images'] = 'onclick="image_upload();"';
				$this->data['product_download'] = 'href="' . $this->url->link('account/product_download', '', 'SSL') . '"';
				$this->data['text_my_reports'] = $this->language->get('text_my_reports');
				$this->data['text_sales_history'] = $this->language->get('text_sales_history');
				$this->data['sales_history'] = 'href="' . $this->url->link('account/sales', '', 'SSL') . '"';
				$this->data['text_product_viewed'] = $this->language->get('text_product_viewed');
				$this->data['product_viewed'] = 'href="' . $this->url->link('account/product_viewed', '', 'SSL') . '"';
			}
			]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[
			$this->data['heading_title'] = $this->language->get('heading_title');
			]]></search>
			<add><![CDATA[
			$this->data['heading_title'] = (($this->customer->getCustomerProductManager()) ? $this->language->get('membership_heading_title') : $this->language->get('heading_title'));
			]]></add>
		</operation>
	</file>
	
	<file name="catalog/language/english/account/account.php">
		<operation>
			<search position="bottom" offset="2"></search>
			<add><![CDATA[
			$_['membership_heading_title']	= 'My Membership Account';
			$_['text_product']       		= 'Manage your product listings';
			$_['text_product_images']       	= 'Manage your images';
			$_['text_product_download']	= 'Manage digital file downloads';
			$_['text_my_products']		= 'My Products';
			$_['text_my_sales']			= 'My Sales';
			$_['text_my_reports']			= 'My Reports';
			$_['text_sales_history']		= 'View your product sales history';
			$_['text_product_viewed']		= 'View your product listing views';
			]]></add>
		</operation>
	</file>
	
	<file name="catalog/view/theme/default/template/account/account.tpl">
		<operation>
			<search position="before"><![CDATA[
			<?php echo $text_my_orders; ?>
			]]></search>
			<add><![CDATA[
			<?php if ($this->config->get('cpm_status') && $this->customer->getCustomerProductManager()) {  ?>
			<?php if ($this->config->get('cpm_product_manager')) { ?>
			<h2><?php echo $text_my_products; ?></h2>
			<div class="content">
				<ul>
					<li><a <?php echo (isset($product) ? $product : ''); ?> style="cursor:pointer;"><?php echo $text_product; ?></a></li>
					<li><a <?php echo (isset($product_images) ? $product_images : ''); ?> style="cursor:pointer;"><?php echo $text_product_images; ?></a></li>
					<?php if ($this->config->get('cpm_tab_download')) { ?><li><a <?php echo (isset($product_download) ? $product_download : ''); ?> style="cursor:pointer;"><?php echo $text_product_download; ?></a></li><?php } ?>					
				</ul>
			</div>
			<?php } ?>
			<?php if ($this->config->get('cpm_report')) { ?>
			<h2><?php echo $text_my_reports; ?></h2>
			<div class="content">
				<ul>
					<li><a <?php echo (isset($sales_history) ? $sales_history : ''); ?> style="cursor:pointer;"><?php echo $text_sales_history; ?></a></li>
					<li><a <?php echo (isset($product_viewed) ? $product_viewed : ''); ?> style="cursor:pointer;"><?php echo $text_product_viewed; ?></a></li>
				</ul>
			</div>
			<?php } ?>
			<?php } ?>
			]]></add>
		</operation>
		<operation>
			<search position="bottom" offset="2"></search>
			<add><![CDATA[
			<script type="text/javascript"><!--
			function imageMaxWarning() {
			   alert("Error: You have exceeded the max number of images!");
			}
			function image_upload() {
				//if(){
				//	imageMaxWarning();
				//	return;
				//}
				$('#dialog').remove();
				$('#container').prepend('<div id="dialog" style="padding: 3px 0px 0px 0px;"><iframe src="index.php?route=common/filemanager" style="padding:0; margin: 0; display: block; width: 100%; height: 100%;" frameborder="no" scrolling="auto"></iframe></div>');
				$('#dialog').dialog({
					title: 'Product Images Manager',
					close: function (text) {},	
					bgiframe: false,
					width: 800,
					height: 400,
					resizable: false,
					modal: false
				});
			};
			//--></script>
			]]></add>
		</operation>
	</file>

	<file name="catalog/controller/account/edit.php">
		<operation>
			<search position="replace"><![CDATA[
			$this->model_account_customer->editCustomer($this->request->post);
			]]></search>
			<add><![CDATA[
			// CPM edit member
			if (($this->config->get('cpm_status')) && ($this->customer->getCustomerProductManager())) {
				$this->load->model('catalog/member');
				$this->model_catalog_member->editMember($this->request->post);
			} else {
				$this->model_account_customer->editCustomer($this->request->post);
			}
			]]></add>
		</operation>
		<operation>
			<search position="after"><![CDATA[
			$this->data['button_back']
			]]></search>
			<add><![CDATA[
			if (($this->config->get('cpm_status')) && ($this->customer->getCustomerProductManager())) {
			/* CPM Start */
			$this->data['entry_cpm_account_name'] = $this->language->get('entry_cpm_account_name');
			$this->data['entry_cpm_account_description'] = $this->language->get('entry_cpm_account_description');
			$this->data['entry_cpm_account_image'] = $this->language->get('entry_cpm_account_image');
			$this->data['entry_cpm_custom_field_01'] = $this->config->get('cpm_custom_field_01');
			$this->data['entry_cpm_custom_field_02'] = $this->config->get('cpm_custom_field_02');
			$this->data['entry_cpm_custom_field_03'] = $this->config->get('cpm_custom_field_03');
			$this->data['entry_cpm_custom_field_04'] = $this->config->get('cpm_custom_field_04');
			$this->data['entry_cpm_custom_field_05'] = $this->config->get('cpm_custom_field_05');
			$this->data['entry_cpm_custom_field_06'] = $this->config->get('cpm_custom_field_06');
			$this->data['entry_cpm_paypal_account'] = $this->language->get('entry_cpm_paypal_account');
			$this->data['text_your_cpm_account'] = $this->language->get('text_your_cpm_account');
			$this->data['text_custom_fields'] = $this->language->get('text_custom_fields');
			$this->data['button_upload'] = $this->language->get('button_upload');
			$this->data['text_clear'] = $this->language->get('text_clear');
			$this->data['help_cpm_paypal_account'] = $this->language->get('help_cpm_paypal_account');
			$this->data['help_cpm_custom_fields'] = $this->language->get('help_cpm_custom_fields');

			if (isset($this->error['cpm_account_name'])) {
				$this->data['error_cpm_account_name'] = $this->error['cpm_account_name'];
			} else {
				$this->data['error_cpm_account_name'] = '';
			}

			if (isset($this->error['cpm_account_description'])) {
				$this->data['error_cpm_account_description'] = $this->error['cpm_account_description'];
			} else {
				$this->data['error_cpm_account_description'] = '';
			}

			if (isset($this->error['cpm_paypal_account'])) {
				$this->data['error_cpm_paypal_account'] = $this->error['cpm_paypal_account'];
			} else {
				$this->data['error_cpm_paypal_account'] = '';
			}

			if (isset($this->error['cpm_account_image'])) {
				$this->data['error_cpm_account_image'] = $this->error['cpm_account_image'];
			} else {
				$this->data['error_cpm_account_image'] = '';
			}

			if (isset($this->error['cpm_custom_fields'])) {
				$this->data['error_cpm_custom_fields'] = $this->error['cpm_custom_fields'];
			} else {
				$this->data['error_cpm_custom_fields'] = '';
			}
			/* CPM End */
			}
			]]></add>
		</operation>
		<operation>
			<search position="before"><![CDATA[
			$this->data['back']
			]]></search>
			<add><![CDATA[
			if (($this->config->get('cpm_status')) && ($this->customer->getCustomerProductManager())) {
			/* CPM START  */
			$cpm_data_fields = array(
				'cpm_account_name',
				'cpm_account_description',
				'cpm_account_image',
				'cpm_custom_field_01',
				'cpm_custom_field_02',
				'cpm_custom_field_03',
				'cpm_custom_field_04',
				'cpm_custom_field_05',
				'cpm_custom_field_06',
				'cpm_paypal_account'
			);
			
			foreach ($cpm_data_fields as $cpm_data_field) {
				if (isset($this->request->post[$cpm_data_field])) {
					$this->data[$cpm_data_field] = $this->request->post[$cpm_data_field];
				} elseif (isset($customer_info)) {
					$this->data[$cpm_data_field] = $customer_info[$cpm_data_field];
				} else {
					$this->data[$cpm_data_field] = '';
				}
			}

			$this->load->model('tool/image');
		
			if (!empty($this->request->post['cpm_account_image']) && file_exists(DIR_IMAGE . $this->request->post['cpm_account_image'])) {
				$this->data['cpm_account_image_thumb'] = $this->model_tool_image->resize($this->request->post['cpm_account_image'], 100, 100);
			} elseif (isset($customer_info) && !empty($customer_info['cpm_account_image'])) {
				$this->data['cpm_account_image_thumb'] = $this->model_tool_image->resize($customer_info['cpm_account_image'], 100, 100);
			} else {
				$this->data['cpm_account_image_thumb'] = $this->model_tool_image->resize('no_image.jpg', 100, 100);
			}

			$this->data['no_image'] = $this->model_tool_image->resize('no_image.jpg', 100, 100);
			/* CPM END */
			}
			]]></add>
		</operation>
		<operation>
			<search position="before"><![CDATA[
			if (!$this->error)
			]]></search>
			<add><![CDATA[
			if (($this->config->get('cpm_status')) && ($this->customer->getCustomerProductManager())) {
				// validation for CPM Customer Account fields on Customer Form
				if ((utf8_strlen($this->request->post['cpm_account_description']) < 1) || (utf8_strlen($this->request->post['cpm_account_description']) > 1500)) {
					$this->error['cpm_account_description'] = $this->language->get('error_cpm_account_description');
			    	}

				if ((utf8_strlen($this->request->post['cpm_account_name']) < 1) || (utf8_strlen($this->request->post['cpm_account_name']) > 128)) {
			      		$this->error['cpm_account_name'] = $this->language->get('error_cpm_account_name');
			    	}

				if (!empty($this->request->post['cpm_paypal_account'])) {
					if (utf8_strlen($this->request->post['cpm_paypal_account']) > 96 || !preg_match('/^[^\@]+@.*\.[a-z]{2,6}$/i', $this->request->post['cpm_paypal_account'])) {
						$this->error['cpm_paypal_account'] = $this->language->get('error_cpm_paypal_account');
					}
					
					if (!$this->config->get('cpm_member_paypal')) {
						$this->error['cpm_paypal_account'] = $this->language->get('error_cpm_paypal_account_disabled');				
					}
				} elseif ($this->config->get('cpm_member_paypal_require')) {
					$this->error['cpm_paypal_account'] = $this->language->get('error_cpm_paypal_account_required');
				}

				if (empty($this->request->post['cpm_account_image'])) {
			      		$this->error['cpm_account_image'] = $this->language->get('error_cpm_account_image');
				}

				$cpm_custom_fields = array('cpm_custom_field_01', 'cpm_custom_field_02', 'cpm_custom_field_03', 'cpm_custom_field_04', 'cpm_custom_field_05', 'cpm_custom_field_06');
				foreach ($cpm_custom_fields as $cpm_custom_field) {
					if (utf8_strlen($this->request->post[$cpm_custom_field]) > 128) {
						$this->error['cpm_custom_fields'] = $this->language->get('error_cpm_custom_fields');
					}
				}
			}
			]]></add>
		</operation>
		<operation>
			<search position="bottom" offset="2"></search>
			<add><![CDATA[
			public function upload() {
				if ($this->config->get('cpm_status') !== '1' || ($this->customer->getCustomerProductManager() !== '1')) {
					$this->redirect($this->url->link('account/register', '', 'SSL'));
				}
		
				$this->language->load('account/register_cpm');
	
				$json = array();
	
				if (!empty($this->request->files['file']['name'])) {
					// $filename = basename(html_entity_decode($this->request->files['file']['name'], ENT_QUOTES, 'UTF-8'));
					$filename = basename(preg_replace('/[^a-zA-Z0-9\.\-\s+]/', '', html_entity_decode($this->request->files['file']['name'], ENT_QUOTES, 'UTF-8')));

					if ((utf8_strlen($filename) < 3) || (utf8_strlen($filename) > 128)) {
						$json['error'] = $this->language->get('error_filename');
					}	  	
				
					// Allowed file extension types
					$allowed = array(
							'jpg',
							'jpeg',
							'gif',
							'png',
						);
		
					if (!in_array(substr(strrchr(strtolower($filename), '.'), 1), $allowed)) {
						$json['error'] = $this->language->get('error_filetype');
					}
		
					// Allowed file mime types
					$allowed = array(
						'image/jpeg',
						'image/pjpeg',
						'image/gif',
						'image/png'
					);
						
					if (!in_array($this->request->files['file']['type'], $allowed)) {
						$json['error'] = $this->language->get('error_filetype');
					}
		
					if ($this->request->files['file']['error'] != UPLOAD_ERR_OK) {
						$json['error'] = $this->language->get('error_upload_' . $this->request->files['file']['error']);
					}
				} else {
					$json['error'] = $this->language->get('error_upload');
				}

				if (!isset($json['error'])) {
					if (is_uploaded_file($this->request->files['file']['tmp_name']) && file_exists($this->request->files['file']['tmp_name'])) {
						$this->load->model('tool/image');				 
						$json['filename'] = 'data/' . $this->customer->getCPMImagesDirectory() . '/' . $filename;
						move_uploaded_file($this->request->files['file']['tmp_name'], DIR_IMAGE . 'data/' . $this->customer->getCPMImagesDirectory() . '/' . $filename);
						$json['thumb'] = $this->model_tool_image->resize($json['filename'], 100, 100);
					}
					
					$json['success'] = $this->language->get('text_upload');
				}	

				$this->response->setOutput(json_encode($json));
			}
				
			private function friendlyURL($inputString) {
				$url = strtolower($inputString);
				$patterns = $replacements = array();
				$patterns[0] = '/(&amp;|&)/i';
				$replacements[0] = '-and-';
				$patterns[1] = '/[^a-zA-Z01-9]/i';
				$replacements[1] = '-';
				$patterns[2] = '/(-+)/i';
				$replacements[2] = '-';
				$patterns[3] = '/(-$|^-)/i';
				$replacements[3] = '';
				$url = preg_replace($patterns, $replacements, $url);
				return $url;
			}
			]]></add>
		</operation>
	</file>
	
	<file name="catalog/view/theme/default/template/account/edit.tpl">
		<operation>
			<search position="after" offset="1"><![CDATA[
			</table>
			]]></search>
			<add><![CDATA[
			<?php if (($this->config->get('cpm_status')) && ($this->customer->getCustomerProductManager())) { ?>
			<h2><?php echo $text_your_cpm_account; ?></h2>
			    <div class="content">
			      <table class="form">
				<tr>
				  <td><span class="required">*</span> <?php echo $entry_cpm_account_name; ?></td>
				  <td><input type="text" name="cpm_account_name" value="<?php echo $cpm_account_name; ?>" size="40" />
				    <?php if ($error_cpm_account_name) { ?>
				    <span class="error"><?php echo $error_cpm_account_name; ?></span>
				    <?php } ?></td>
				</tr>
				<tr>
				  <td><span class="required">*</span> <?php echo $entry_cpm_account_description; ?></td>
				  <td><textarea name="cpm_account_description" cols="25" rows="3"><?php echo $cpm_account_description; ?></textarea>
				    <?php if ($error_cpm_account_description) { ?>
				    <span class="error"><?php echo $error_cpm_account_description; ?></span>
				    <?php } ?></td>
				</tr>
				<tr>
					<td><?php echo $entry_cpm_account_image; ?></td>				    
					<td><div class="image" style="border:1px solid #EEEEEE; padding:10px; display:inline-block;"><img src="<?php echo $cpm_account_image_thumb; ?>" alt="" id="cpm_account_image_thumb" style="padding-bottom:5px;" /><br />
					<input type="hidden" name="cpm_account_image" value="<?php echo $cpm_account_image; ?>" id="cpm_account_image" />
					<a id="button-upload"><?php echo $button_upload; ?></a>&nbsp;&nbsp;|&nbsp;&nbsp;<a onclick="$('#cpm_account_image_thumb').attr('src', '<?php echo $no_image; ?>'); $('#cpm_account_image').attr('value', '');"><?php echo $text_clear; ?></a></div>
				    <?php if ($error_cpm_account_image) { ?>
				    <span class="error"><?php echo $error_cpm_account_image; ?></span>
				    <?php } ?></td>
				</tr>
				<?php if ($this->config->get('cpm_member_paypal')) { ?>
				<tr>
				  <td><?php if($this->config->get('cpm_member_paypal_require')) { ?><span class="required">*</span>&nbsp;<?php } ?><?php echo $entry_cpm_paypal_account; ?></td>
				  <td><input type="text" name="cpm_paypal_account" value="<?php echo $cpm_paypal_account; ?>" />
				    <?php if ($this->config->get('cpm_member_paypal_require')) { ?><br /><em><?php echo $help_cpm_paypal_account; ?></em><?php } ?>
				    <?php if ($error_cpm_paypal_account) { ?>
				    <span class="error"><?php echo $error_cpm_paypal_account; ?></span>
				    <?php } ?></td>
				</tr>
				<?php } ?>
			      </table>
			      <div id="custom-fields" <?php if (!$entry_cpm_custom_field_01 && !$entry_cpm_custom_field_02 && !$entry_cpm_custom_field_03 && !$entry_cpm_custom_field_04 && !$entry_cpm_custom_field_05 && !$entry_cpm_custom_field_06) echo 'style="display:none;"'; ?>>
			      <h3><?php echo $text_custom_fields; ?></h3>
			      <table class="form">
				<?php if ($error_cpm_custom_fields) { ?>
				<p><span class="error"><?php echo $error_cpm_custom_fields; ?></span></p>
				<?php } ?>
				<tr <?php if (!$entry_cpm_custom_field_01) echo 'style="display:none;"'; ?>>
					<td><?php echo $entry_cpm_custom_field_01; ?></td>
					<td><input type="text" name="cpm_custom_field_01" value="<?php echo $cpm_custom_field_01; ?>" /></td>
				</tr>
				<tr <?php if (!$entry_cpm_custom_field_02) echo 'style="display:none;"'; ?>>
					<td><?php echo $entry_cpm_custom_field_02; ?></td>
					<td><input type="text" name="cpm_custom_field_02" value="<?php echo $cpm_custom_field_02; ?>" /></td>
				</tr>
				<tr <?php if (!$entry_cpm_custom_field_03) echo 'style="display:none;"'; ?>>
					<td><?php echo $entry_cpm_custom_field_03; ?></td>
					<td><input type="text" name="cpm_custom_field_03" value="<?php echo $cpm_custom_field_03; ?>" /></td>
				</tr>
				<tr <?php if (!$entry_cpm_custom_field_04) echo 'style="display:none;"'; ?>>
					<td><?php echo $entry_cpm_custom_field_04; ?></td>
					<td><input type="text" name="cpm_custom_field_04" value="<?php echo $cpm_custom_field_04; ?>" /></td>
				</tr>
				<tr <?php if (!$entry_cpm_custom_field_05) echo 'style="display:none;"'; ?>>
					<td><?php echo $entry_cpm_custom_field_05; ?></td>
					<td><input type="text" name="cpm_custom_field_05" value="<?php echo $cpm_custom_field_05; ?>" /></td>
				</tr>
				<tr <?php if (!$entry_cpm_custom_field_06) echo 'style="display:none;"'; ?>>
					<td><?php echo $entry_cpm_custom_field_06; ?></td>
					<td><input type="text" name="cpm_custom_field_06" value="<?php echo $cpm_custom_field_06; ?>" /></td>
				</tr>
			      </table>
			      </div><!-- #custom-fields -->
			    </div>
			<?php } // END CPM IF ?>
			]]></add>
		</operation>
		<operation>
			<search position="before"><![CDATA[
			$footer
			]]></search>
			<add><![CDATA[
			<?php if (($this->config->get('cpm_status')) && ($this->customer->getCustomerProductManager())) { ?>
			<script type="text/javascript" src="catalog/view/javascript/ckeditor/ckeditor.js"></script> 
			<script type="text/javascript"><!--
			CKEDITOR.replace('cpm_account_description');
			//--></script>
			<script type="text/javascript" src="catalog/view/javascript/jquery/ajaxupload.js"></script> 
			<script type="text/javascript"><!--
			new AjaxUpload('#button-upload', {
				action: 'index.php?route=account/edit/upload',
				name: 'file',
				autoSubmit: true,
				responseType: 'json',
				onSubmit: function(file, extension) {
					$('#button-upload').after('<img src="catalog/view/theme/default/image/loading.gif" class="loading" style="padding-left: 5px;" />');
					$('#button-upload').attr('disabled', true);
				},
				onComplete: function(file, json) {
					$('#button-upload').attr('disabled', false);
		
					if (json['success']) {
						alert(json['success']);
						$('input[name=\'cpm_account_image\']').attr('value', json['filename']);
						$('#cpm_account_image_thumb').attr('src', json['thumb']);
					}
		
					if (json['error']) {
						alert(json['error']);
					}
		
					$('.loading').remove();	
				}
			});
			//--></script>
			<?php } // END CPM IF ?>
			]]></add>
		</operation>
	</file>
	
	<file name="catalog/language/english/account/edit.php">
		<operation>
			<search position="bottom" offset="2"></search>
			<add><![CDATA[
			// CPM Module Extension
			$_['entry_cpm_account_name'] 		= 'Account Name:';
			$_['entry_cpm_account_description'] 	= 'Account Description:';
			$_['entry_cpm_account_image'] 		= 'Account Image:';
			$_['entry_cpm_paypal_account']		= 'PayPal E-mail:';
			$_['text_your_cpm_account']		= 'Your Membership Info';
			$_['text_custom_fields']		= 'Custom Field(s)';
			$_['text_upload']      			= 'Your file was successfully uploaded!';
			$_['text_clear']             		= 'Clear Image';
			$_['error_cpm_account_description']     = 'Account Description is required and must be less than 1,500 characters!';
			$_['error_cpm_account_name']            = 'Account Name is required and must be less than 128 characters!';
			$_['error_cpm_account_image']           = 'Account Image is required!';
			$_['error_cpm_paypal_account']          = 'PayPal account e-mail is invalid!';
			$_['error_cpm_paypal_account_disabled']	= 'PayPal account e-mail is disabled!';
			$_['error_cpm_paypal_account_required'] = 'PayPal account e-mail is required!';
			$_['error_cpm_custom_fields']           = 'Additional Field(s) must be less than 128 characters!';
			$_['error_filename']   					= 'Filename must be between 3 and 128 characters!';
			$_['error_filetype']  					= 'Invalid image file type! Must be JPG, GIF, or PNG.';
			$_['help_cpm_paypal_account']           = 'PayPal account e-mail is required for transferring sales.';
			]]></add>
		</operation>
	</file>
	
	<file name="catalog/model/account/customer.php">
		<operation>
			<search position="replace"><![CDATA[
			status = '1', approved =
			]]></search>
			<add><![CDATA[
			status = '1', cpm_enabled = '0', approved =
			]]></add>
		</operation>
		<operation>
			<search position="after"><![CDATA[
			$customer_group_id = $data['customer_group_id'];
			]]></search>
			<add><![CDATA[
			} elseif (($this->config->get('cpm_customer_group')) && (isset($data['cpm_account_name']))) {
				$customer_group_id = $this->config->get('cpm_customer_group');   // default cpm setting value
			]]></add>
		</operation>
		<operation>
			<search position="after"><![CDATA[
			$customer_id = $this->db->getLastId();
			]]></search>
			<add><![CDATA[
			if (isset($data['cpm_account_name'])) {
				$this->load->model('catalog/member');				
				$data['customer_id'] = $customer_id;				
				$this->model_catalog_member->addMember($data);
			}
			]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[
			$query = $this->db->query("SELECT * FROM " . DB_PREFIX . "customer WHERE customer_id = '" . (int)$customer_id . "'");
			]]></search>
			<add><![CDATA[
			$query = $this->db->query("SELECT * FROM " . DB_PREFIX . "customer c LEFT JOIN " . DB_PREFIX . "customer_cpm_account ccpm ON c.customer_id = ccpm.customer_id WHERE c.customer_id = '" . (int)$customer_id . "'");
			]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[
			$this->language->get('text_welcome')
			]]></search>
			<add><![CDATA[
			(isset($data['cpm_account_name']) ? $this->language->get('text_welcome_cpm') : $this->language->get('text_welcome'))
			]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[
			$this->language->get('text_services')
			]]></search>
			<add><![CDATA[
			(isset($data['cpm_account_name']) ? $this->language->get('text_services_cpm') : $this->language->get('text_services'))
			]]></add>
		</operation>
	</file>
	
	<!-- FRONT-END PRODUCT -->
	
	<file name="catalog/controller/product/product.php">
		<operation>
			<search position="after"><![CDATA[
			$this->load->model('catalog/manufacturer');
			]]></search>
			<add><![CDATA[
			if ($this->config->get('cpm_status')) {
			$this->load->model('catalog/member');
				
			if (isset($this->request->get['member_id'])) {
				$this->data['breadcrumbs'][] = array( 
					'text'      => $this->language->get('text_member'),
					'href'      => $this->url->link('product/member'),
					'separator' => $this->language->get('text_separator')
				);	
				
				$member_info = $this->model_catalog_member->getMember($this->request->get['member_id']);

				if ($member_info) {	
					$this->data['breadcrumbs'][] = array(
						'text'	    => $member_info['cpm_account_name'],
						'href'	    => $this->url->link('product/member/info', 'member_id=' . $this->request->get['member_id']),					
						'separator' => $this->language->get('text_separator')
					);
				}
			}
			}
			]]></add>
		</operation>
		<operation>
			<search position="before" offset="1"><![CDATA[
			$url .= '&manufacturer_id=' . $this->request->get['manufacturer_id'];
			]]></search>
			<add><![CDATA[
			if (isset($this->request->get['member_id'])) {
				$url .= '&member_id=' . $this->request->get['member_id'];
			}
			]]></add>
		</operation>
		<operation>
			<search position="after"><![CDATA[
			$this->data['text_manufacturer']
			]]></search>
			<add><![CDATA[
			$this->data['text_member'] = $this->language->get('text_member');
			]]></add>
		</operation>
		<operation>
			<search position="after"><![CDATA[
			$this->data['product_id']
			]]></search>
			<add><![CDATA[
			$this->data['member'] = $product_info['member'];
			$this->data['members'] = $this->url->link('product/member/info', 'member_id=' . $product_info['member_id']); 
			if ($this->config->get('cpm_status') && $product_info['member']) {
				// $this->load->model('catalog/member'); // already loaded above in breadcrumb check
				$this->load->model('tool/image');
				$member_info = $this->model_catalog_member->getMember($product_info['member_id']);
			
				if (isset($member_info['cpm_account_image'])) {
					$this->data['member_image'] = $this->model_tool_image->resize($member_info['cpm_account_image'],60,60);
				} else {
					$this->data['member_image'] =  ''; // $this->model_tool_image->resize('no_image.jpg',60,60);
				}
			}
			]]></add>
		</operation>
	</file>
	
	<file name="catalog/language/english/product/product.php">
		<operation>
			<search position="bottom" offset="2"></search>
			<add><![CDATA[
			$_['text_member'] = 'Member';
			]]></add>
		</operation>
	</file>
	
	<file name="catalog/view/theme/default/template/product/product.tpl">
		<operation>
			<search position="before"><![CDATA[
			<?php if ($manufacturer) { ?>
			]]></search>
			<add><![CDATA[
			<?php if (($this->config->get('cpm_status')) && $member) { ?>
			<span><?php echo $text_member; ?></span>: <a href="<?php echo $members; ?>"><?php echo $member; ?></a> 
			<?php if ($member_image) { ?>
				<a href="<?php echo $members; ?>"><img src="<?php echo $member_image; ?>" title="<?php echo $member; ?>" alt="<?php echo $member; ?> image" style="vertical-align:middle;" /></a><br />
			<?php } else { ?>
				<br />
			<?php } ?>
			<?php } ?>
			]]></add>
		</operation>
	</file>

	<file name="catalog/model/catalog/product.php">
		<operation>
			<search position="replace"><![CDATA[
			p.status = '1'
			]]></search>
			<add><![CDATA[
			p.status = '1' AND p.cpm_approved = '1'
			]]></add>
		</operation>
		<operation>
			<search position="before"><![CDATA[
			$query = $this->db->query("SELECT DISTINCT *, pd.name AS name, p.image,
			]]></search>
			<add><![CDATA[
			if ($this->config->get('cpm_status')) {
				$query = $this->db->query("SELECT DISTINCT *, pd.name AS name, p.image, m.name AS manufacturer, cpm.cpm_account_name AS member, (SELECT price FROM " . DB_PREFIX . "product_discount pd2 WHERE pd2.product_id = p.product_id AND pd2.customer_group_id = '" . (int)$customer_group_id . "' AND pd2.quantity = '1' AND ((pd2.date_start = '0000-00-00' OR pd2.date_start < NOW()) AND (pd2.date_end = '0000-00-00' OR pd2.date_end > NOW())) ORDER BY pd2.priority ASC, pd2.price ASC LIMIT 1) AS discount, (SELECT price FROM " . DB_PREFIX . "product_special ps WHERE ps.product_id = p.product_id AND ps.customer_group_id = '" . (int)$customer_group_id . "' AND ((ps.date_start = '0000-00-00' OR ps.date_start < NOW()) AND (ps.date_end = '0000-00-00' OR ps.date_end > NOW())) ORDER BY ps.priority ASC, ps.price ASC LIMIT 1) AS special, (SELECT points FROM " . DB_PREFIX . "product_reward pr WHERE pr.product_id = p.product_id AND customer_group_id = '" . (int)$customer_group_id . "') AS reward, (SELECT ss.name FROM " . DB_PREFIX . "stock_status ss WHERE ss.stock_status_id = p.stock_status_id AND ss.language_id = '" . (int)$this->config->get('config_language_id') . "') AS stock_status, (SELECT wcd.unit FROM " . DB_PREFIX . "weight_class_description wcd WHERE p.weight_class_id = wcd.weight_class_id AND wcd.language_id = '" . (int)$this->config->get('config_language_id') . "') AS weight_class, (SELECT lcd.unit FROM " . DB_PREFIX . "length_class_description lcd WHERE p.length_class_id = lcd.length_class_id AND lcd.language_id = '" . (int)$this->config->get('config_language_id') . "') AS length_class, (SELECT AVG(rating) AS total FROM " . DB_PREFIX . "review r1 WHERE r1.product_id = p.product_id AND r1.status = '1' GROUP BY r1.product_id) AS rating, (SELECT COUNT(*) AS total FROM " . DB_PREFIX . "review r2 WHERE r2.product_id = p.product_id AND r2.status = '1' GROUP BY r2.product_id) AS reviews, p.sort_order FROM " . DB_PREFIX . "product p LEFT JOIN " . DB_PREFIX . "product_description pd ON (p.product_id = pd.product_id) LEFT JOIN " . DB_PREFIX . "product_to_store p2s ON (p.product_id = p2s.product_id) LEFT JOIN " . DB_PREFIX . "manufacturer m ON (p.manufacturer_id = m.manufacturer_id) LEFT JOIN " . DB_PREFIX . "customer_cpm_account cpm ON (p.cpm_customer_id = cpm.customer_id) WHERE p.product_id = '" . (int)$product_id . "' AND pd.language_id = '" . (int)$this->config->get('config_language_id') . "' AND p.status = '1' AND p.cpm_approved = '1' AND p.date_available <= NOW() AND p2s.store_id = '" . (int)$this->config->get('config_store_id') . "'");
			} else {
			]]></add>
		</operation>
		<operation>
			<search position="before" index="1"><![CDATA[
			if ($query->num_rows) {
			]]></search>
			<add><![CDATA[
			}
			]]></add>
		</operation>
		<operation error="skip">
			<search position="after"><![CDATA[
			'manufacturer'
			]]></search>
			<add><![CDATA[
			'member_id'     => $query->row['customer_id'],
			'member'     => $query->row['member'],
			]]></add>
		</operation>
		<operation>
			<search position="before" offset="1"><![CDATA[
			if (!empty($data['filter_manufacturer_id'])) {
			]]></search>
			<add><![CDATA[
			if (!empty($data['filter_member_id'])) {
				$sql .= " AND p.cpm_customer_id = '" . (int)$data['filter_member_id'] . "'";
			}
			]]></add>
		</operation>
		<operation>
			<search position="bottom" offset="2"></search>
			<add><![CDATA[
			public function getTotalProductsByDownloadId($download_id) {
				$query = $this->db->query("SELECT COUNT(*) AS total FROM " . DB_PREFIX . "product_to_download WHERE download_id = '" . (int)$download_id . "'");
				return $query->row['total'];
			}

			public function getTotalProductsByCPMCustomerId($cpm_customer_id) {
				$query = $this->db->query("SELECT COUNT(*) AS total FROM " . DB_PREFIX . "product WHERE cpm_customer_id = '" . (int)$cpm_customer_id . "' AND status = '1' AND cpm_approved = '1'");
				return $query->row['total'];
			}
			]]></add>
		</operation>
	</file>

	<!-- FRONT-END SEARCH -->
	
	<file name="catalog/controller/product/search.php">
		<operation>
			<search position="before" offset="2"><![CDATA[
			$category_id = $this->request->get['category_id'];
			]]></search>
			<add><![CDATA[
			if (isset($this->request->get['member_id'])) {
				$member_id = $this->request->get['member_id'];
			} else {
				$member_id = 0;
			}
			$this->data['member_id'] = $member_id;
			]]></add>
		</operation>
		<operation>
			<search position="before" offset="2"><![CDATA[
			$url .= '&category_id=' . $this->request->get['category_id'];
			]]></search>
			<add><![CDATA[
			if (isset($this->request->get['member_id'])) {
				$url .= '&member_id=' . $this->request->get['member_id'];
			}
			]]></add>
		</operation>
		<operation>
			<search position="after"><![CDATA[
			$this->data['text_manufacturer'] = $this->language->get('text_manufacturer');
			]]></search>
			<add><![CDATA[
			$this->data['text_member'] = $this->language->get('text_member');
			]]></add>
		</operation>
		<operation>
			<search position="before"><![CDATA[
			$this->data['categories'] = array();
			]]></search>
			<add><![CDATA[
			if ($this->config->get('cpm_status')) {
				$this->load->model('catalog/member');
				$this->data['members'] = array();
				$members = $this->model_catalog_member->getmembers();
				foreach ($members as $members) {
					$this->data['members'][] = array(
						'member_id' => $members['customer_id'],
						'name'        => $members['cpm_account_name']
					);
				}
			}
			]]></add>
		</operation>
		<operation>
			<search position="after"><![CDATA[
			'filter_description'  => $description,
			]]></search>
			<add><![CDATA[
			'filter_member_id'  => $member_id,
			]]></add>
		</operation>
	</file>
	
	<file name="catalog/language/english/product/search.php">
		<operation>
			<search position="bottom" offset="2"></search>
			<add><![CDATA[
			$_['text_member'] = 'All Members';
			]]></add>
		</operation>
	</file>

	<file name="catalog/view/theme/default/template/product/search.tpl">
		<operation>
			<search position="before"><![CDATA[
			<select name="category_id">
			]]></search>
			<add><![CDATA[
			<?php if ($this->config->get('cpm_status')) { ?>
			<select name="member_id">
				<option value="0"><?php echo $text_member; ?></option>
				<?php foreach ($members as $member) { ?>
				<?php if ($member['member_id'] == $member_id) { ?>
				<option value="<?php echo $member['member_id']; ?>" selected="selected"><?php echo $member['name']; ?></option>
				<?php } else { ?>
				<option value="<?php echo $member['member_id']; ?>"><?php echo $member['name']; ?></option>
				<?php } ?>
				<?php } ?>
		        </select>
			<?php } ?>
			]]></add>
		</operation>
		<operation>
			<search position="before"><![CDATA[
			var category_id =
			]]></search>
			<add><![CDATA[
			var member_id = $('#content select[name=\'member_id\']').attr('value');
	
			if (member_id > 0) {
				url += '&member_id=' + encodeURIComponent(member_id);
			}
			]]></add>
		</operation>
	</file>

	<!-- FRONT-END ORDER -->
	
	<file name="catalog/controller/checkout/manual.php">
		<operation>
			<search position="replace"><![CDATA[
			foreach ($products as $product) {
			]]></search>
			<add><![CDATA[
			if ($this->config->get('cpm_status')) {
				$this->load->model('tool/image');
			}
			foreach ($products as $product) {
				if ($product['image'] && file_exists(DIR_IMAGE . $product['image'])) {
					$image = $this->model_tool_image->resize($product['image'], 40, 40);
				} else {
					$image = $this->model_tool_image->resize('no_image.jpg', 40, 40);
				}
			]]></add>
		</operation>
		<operation>
			<search position="after"><![CDATA[
			$json['order_product'][] = array(
			]]></search>
			<add><![CDATA[
			'cpm_customer_id'             => (!empty($product['cpm_customer_id']) ? $product['cpm_customer_id'] : ''),
			'cpm_member'             	=> (!empty($product['cpm_account_name']) ? $product['cpm_account_name'] : ''),
			'image_display' 			=> $image,
			'image_file' 			=> (!empty($product['image']) ? $product['image'] : ''),
			'cpm_commission'             => (!empty($product['cpm_customer_id']) ? ($product['total'] / 100) * $product['cpm_commission_rate'] : 0),
			]]></add>
		</operation>
	</file>
	
	<file name="catalog/controller/checkout/confirm.php">
		<operation>
			<search position="after"><![CDATA[
			$product['product_id'],
			]]></search>
			<add><![CDATA[
			'cpm_customer_id' => (!empty($product['cpm_customer_id']) ? $product['cpm_customer_id'] : '0'),
			'image' => $product['image'],
			'cpm_commission' => (!empty($product['cpm_customer_id']) ? ($product['total'] / 100) * $product['cpm_commission_rate'] : 0),
			]]></add>
		</operation>
	</file>
	
	<file name="catalog/model/checkout/order.php">
		<operation>
			<search position="replace"><![CDATA[
			, product_id = '" . (int)$product['product_id'] . "'
			]]></search>
			<add><![CDATA[
			, product_id = '" . (int)$product['product_id'] . "', cpm_customer_id = '" . (int)$product['cpm_customer_id'] . "', image = '" . $this->db->escape($product['image']) . "', commission = '" . (float)$product['cpm_commission'] . "'
			]]></add>
		</operation>
	</file>
	
	<file name="catalog/controller/account/order.php">
		<operation>
			<search position="after"><![CDATA[
			$this->data['column_model']
			]]></search>
			<add><![CDATA[
			if ($this->config->get('cpm_status')) { 
				$this->data['column_cpm_member'] = $this->language->get('column_cpm_member');
				$this->data['column_image'] = $this->language->get('column_image');
				$this->data['column_notified'] = $this->language->get('column_notified');
			}			
			]]></add>
		</operation>
		<operation>
			<search position="before"><![CDATA[
			foreach ($products as $product) {
			]]></search>
			<add><![CDATA[
			if ($this->config->get('cpm_status')) {
				$this->load->model('tool/image');
			}
			]]></add>
		</operation>
		<operation>
			<search position="before"><![CDATA[
			$this->data['products'][] = array(
			]]></search>
			<add><![CDATA[
			if ($product['image'] && file_exists(DIR_IMAGE . $product['image'])) {
				$image = $this->model_tool_image->resize($product['image'], 40, 40);
			} else {
				$image = $this->model_tool_image->resize('no_image.jpg', 40, 40);
			}
			]]></add>
		</operation>
		<operation>
			<search position="after"><![CDATA[
			$this->data['products'][] = array(
			]]></search>
			<add><![CDATA[
			'cpm_customer_id'             => (isset($product['cpm_customer_id']) ? $product['cpm_customer_id'] : ''),
			'cpm_member'             	=> (isset($product['cpm_account_name']) ? $product['cpm_account_name'] : ''),
			'image' 				=> $image,
			]]></add>
		</operation>
		<operation>
			<search position="before"><![CDATA[
			$result['comment']
			]]></search>
			<add><![CDATA[
			'member'     => !empty($result['member']) ? $result['member'] : $this->language->get('text_admin'),
			'notified'    => $result['notify'] ? $this->language->get('text_yes') : $this->language->get('text_no'),
			]]></add>
		</operation>
		<operation><!-- lengthen product option description field on order display -->
			<search position="replace"><![CDATA[
			'value' => (utf8_strlen($value) > 20 ? utf8_substr($value, 0, 20) . '..' : $value)
			]]></search>
			<add><![CDATA[
			'value' => (utf8_strlen($value) > 40 ? utf8_substr($value, 0, 40) . '..' : $value)
			]]></add>
		</operation>
	</file>
		
	<file name="catalog/language/english/account/order.php">
		<operation>
			<search position="bottom" offset="2"></search>
			<add><![CDATA[
			$_['column_cpm_member']	= 'Member';
			$_['column_image']          		= 'Image';
			$_['column_notified']  		= 'Notified';
			$_['text_admin']  			= 'Store Admin';
			]]></add>
		</operation>
	</file>
		
	<file name="catalog/model/account/order.php">
		<operation>
			<search position="replace" offset="2"><![CDATA[
			function getOrderProducts($order_id) {
			]]></search>
			<add><![CDATA[
			function getOrderProducts($order_id) {
				if ($this->config->get('cpm_status')) {
					$query = $this->db->query("SELECT * FROM " . DB_PREFIX . "order_product op LEFT JOIN " . DB_PREFIX . "customer_cpm_account cpm ON op.cpm_customer_id = cpm.customer_id WHERE order_id = '" . (int)$order_id . "'");
				} else {
					$query = $this->db->query("SELECT * FROM " . DB_PREFIX . "order_product WHERE order_id = '" . (int)$order_id . "'");
				}
			]]></add>
		</operation>
		<operation>
			<search position="replace" offset="2"><![CDATA[
			function getOrderHistories($order_id) {
			]]></search>
			<add><![CDATA[
			function getOrderHistories($order_id) {
				if ($this->config->get('cpm_status')) {
					$query = $this->db->query("SELECT oh.date_added, os.name AS status, oh.comment, oh.notify, cpm.cpm_account_name AS member FROM " . DB_PREFIX . "order_history oh LEFT JOIN " . DB_PREFIX . "order_status os ON oh.order_status_id = os.order_status_id LEFT JOIN " . DB_PREFIX . "customer_cpm_account cpm ON oh.cpm_customer_id = cpm.customer_id WHERE oh.order_id = '" . (int)$order_id . "' AND oh.notify = '1' AND os.language_id = '" . (int)$this->config->get('config_language_id') . "' ORDER BY oh.date_added");
				} else {
					$query = $this->db->query("SELECT date_added, os.name AS status, oh.comment, oh.notify FROM " . DB_PREFIX . "order_history oh LEFT JOIN " . DB_PREFIX . "order_status os ON oh.order_status_id = os.order_status_id WHERE oh.order_id = '" . (int)$order_id . "' AND oh.notify = '1' AND os.language_id = '" . (int)$this->config->get('config_language_id') . "' ORDER BY oh.date_added");
				}
			]]></add>
		</operation>
	</file>
		
	<file name="catalog/view/theme/default/template/account/order_info.tpl">
		<operation>
			<search position="before"><![CDATA[
			<?php echo $column_name; ?>
			]]></search>
			<add><![CDATA[
			<?php if ($this->config->get('cpm_status')) { ?><td class="left"><?php echo $column_image; ?></td><?php } ?>
			]]></add>
		</operation>
		<operation>
			<search position="before"><![CDATA[
			<?php echo $product['name']; ?>
			]]></search>
			<add><![CDATA[
			<?php if ($this->config->get('cpm_status')) { ?><td class="center"><img src="<?php echo $product['image']; ?>" alt="<?php echo $product['name']; ?>" style="padding: 1px; border: 1px solid #DDDDDD;" /></td><?php } ?>
			]]></add>
		</operation>
		<operation>
			<search position="after"><![CDATA[
			<?php echo $column_model; ?>
			]]></search>
			<add><![CDATA[
			<?php if ($this->config->get('cpm_status')) { ?><td class="left"><?php echo $column_cpm_member; ?></td><?php } ?>
			]]></add>
		</operation>
		<operation>
			<search position="after"><![CDATA[
			<?php echo $product['model']; ?>
			]]></search>
			<add><![CDATA[
			<?php if ($this->config->get('cpm_status')) { ?><td class="left"><?php echo $product['cpm_member']; ?></td><?php } ?>
			]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[
			colspan="3"
			]]></search>
			<add><![CDATA[
			colspan="<?php echo (($this->config->get('cpm_status')) ? '5' : '3'); ?>"
			]]></add>
		</operation>
		<operation>
			<search position="before"><![CDATA[
			<td class="left"><?php echo $column_comment; ?></td>
			]]></search>
			<add><![CDATA[
			<?php if ($this->config->get('cpm_status')) { ?><td class="left"><?php echo $column_cpm_member; ?></td><?php } ?>
			]]></add>
		</operation>
		<operation>
			<search position="before"><![CDATA[
			<td class="left"><?php echo $history['comment']; ?></td>
			]]></search>
			<add><![CDATA[
			<?php if ($this->config->get('cpm_status')) { ?><td class="left"><?php echo $history['member']; ?></td><?php } ?>
			]]></add>
		</operation>
	</file>
	
	<file name="catalog/controller/checkout/cart.php">
		<operation>
			<search position="after"><![CDATA[
			$this->data['column_model']
			]]></search>
			<add><![CDATA[
			$this->data['column_member'] = $this->language->get('column_member');
			]]></add>
		</operation>
		<operation>
			<search position="after"><![CDATA[
			$this->data['products'][] = array(
			]]></search>
			<add><![CDATA[
			'member' => (!empty($product['member']) ? $product['member'] : '' ),
			'cpm_customer_id' => (!empty($product['cpm_customer_id']) ? $product['cpm_customer_id'] : '' ),
			]]></add>
		</operation>
	</file>
	
	<file name="catalog/controller/checkout/confirm.php">
		<operation>
			<search position="after"><![CDATA[
			$this->data['column_model']
			]]></search>
			<add><![CDATA[
			$this->data['column_member'] = $this->language->get('column_member');
			]]></add>
		</operation>
		<operation>
			<search position="after"><![CDATA[
			$this->data['products'][] = array(
			]]></search>
			<add><![CDATA[
			'member' => (!empty($product['member']) ? $product['member'] : '' ),
			'cpm_customer_id' => (!empty($product['cpm_customer_id']) ? $product['cpm_customer_id'] : '' ),
			]]></add>
		</operation>
	</file>
	
	<file name="catalog/language/english/checkout/cart.php">
		<operation>
			<search position="bottom" offset="2"></search>
			<add><![CDATA[
			$_['column_member']           = 'Member';
			]]></add>
		</operation>
	</file>
	
	<file name="catalog/language/english/checkout/checkout.php">
		<operation>
			<search position="bottom" offset="2"></search>
			<add><![CDATA[
			$_['column_member']           = 'Member';
			]]></add>
		</operation>
	</file>

	<file name="catalog/view/theme/default/template/checkout/cart.tpl">
		<operation>
			<search position="after"><![CDATA[
			<td class="model"><?php echo $column_model; ?></td>
			]]></search>
			<add><![CDATA[
			<?php if ($this->config->get('cpm_status')) { ?><td class="model"><?php echo $column_member; ?></td><?php } ?>
			]]></add>
		</operation>
		<operation>
			<search position="after"><![CDATA[
			<?php echo $product['model']; ?>
			]]></search>
			<add><![CDATA[
			<?php if ($this->config->get('cpm_status')) { ?><td class="model"><?php echo $product['member']; ?></td><?php } ?>
			]]></add>
		</operation>
	</file>

	<file name="catalog/view/theme/default/template/checkout/confirm.tpl">
		<operation>
			<search position="after"><![CDATA[
			<td class="model"><?php echo $column_model; ?></td>
			]]></search>
			<add><![CDATA[
			<?php if ($this->config->get('cpm_status')) { ?><td class="model"><?php echo $column_member; ?></td><?php } ?>
			]]></add>
		</operation>
		<operation>
			<search position="after"><![CDATA[
			<?php echo $product['model']; ?>
			]]></search>
			<add><![CDATA[
			<?php if ($this->config->get('cpm_status')) { ?><td class="model"><?php echo $product['member']; ?></td><?php } ?>
			]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[
			colspan="4"
			]]></search>
			<add><![CDATA[
			colspan="<?php echo (($this->config->get('cpm_status')) ? '5' : '4'); ?>"
			]]></add>
		</operation>
	</file>
	
	<file name="catalog/controller/checkout/confirm.php">
		<operation><!-- lengthen product option description field on order display -->
			<search position="replace"><![CDATA[
			'value' => (utf8_strlen($value) > 20 ? utf8_substr($value, 0, 20) . '..' : $value)
			]]></search>
			<add><![CDATA[
			'value' => (utf8_strlen($value) > 40 ? utf8_substr($value, 0, 40) . '..' : $value)
			]]></add>
		</operation>
	</file>
	
	<file name="catalog/model/checkout/order.php">
		<operation><!-- lengthen product option description field on order email -->
			<search position="replace"><![CDATA[
			'value' => (utf8_strlen($value) > 20 ? utf8_substr($value, 0, 20) . '..' : $value)
			]]></search>
			<add><![CDATA[
			'value' => (utf8_strlen($value) > 40 ? utf8_substr($value, 0, 40) . '..' : $value)
			]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[
			$order_product_query = $this->db->query("SELECT * FROM " . DB_PREFIX . "order_product WHERE order_id = '" . (int)$order_id . "'");
			]]></search>
			<add><![CDATA[
			if ($this->config->get('cpm_status')) {
				$order_product_query = $this->db->query("SELECT *, cpm.cpm_account_name AS member FROM " . DB_PREFIX . "order_product op LEFT JOIN " . DB_PREFIX . "customer_cpm_account cpm ON (op.cpm_customer_id = cpm.customer_id) WHERE order_id = '" . (int)$order_id . "'");
			} else {
				$order_product_query = $this->db->query("SELECT * FROM " . DB_PREFIX . "order_product WHERE order_id = '" . (int)$order_id . "'");
			}
			]]></add>
		</operation>
		<operation>
			<search position="before"><![CDATA[
			$template->data['text_model']
			]]></search>
			<add><![CDATA[
			$template->data['text_member'] = $language->get('text_member');
			$template->data['text_image'] = $language->get('text_image');
			$template->data['cpm_enabled'] = ($this->config->get('cpm_status') ? true : false);
			]]></add>
		</operation>
		<operation>
			<search position="before"><![CDATA[
			$template->data['products'][] = array(
			]]></search>
			<add><![CDATA[
			$this->load->model('tool/image');
			
			if ($product['image'] && file_exists(DIR_IMAGE . $product['image'])) {
				$thumb = $this->model_tool_image->resize($product['image'], 40, 40);
			} else {
				$thumb = $this->model_tool_image->resize('no_image.jpg', 40, 40);
			}
			]]></add>
		</operation>
		<operation>
			<search position="before"><![CDATA[
			$product['model'],
			]]></search>
			<add><![CDATA[
			'member'    => (!empty($product['member']) ? $product['member'] : ''),
			'image'    => $thumb,
			]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[
			. ' (' . $product['model'] . ') '
			]]></search>
			<add><![CDATA[
			. ' (' . $product['model'] . (!empty($product['member']) ? ', ' . $product['member'] : '') . ') '
			]]></add>
		</operation>
		<operation>
			<search position="before" offset="1"><![CDATA[
			$this->config->get('config_alert_emails')
			]]></search>
			<add><![CDATA[
			// sends a copy of admin order alert email to the cpm-enabled customer who is the owner of each product on the order
			if ($this->config->get('cpm_status') && $this->config->get('cpm_email_customers')) {
				$this->load->model('account/product');
				
				$cpm_customers_emailed = array();

				foreach ($order_product_query->rows as $product) {
					$cpm_customer_id = $this->model_account_product->getCustomerIdByProduct($product['product_id']);
					if ($cpm_customer_id) {
						$cpm_customer = $this->model_account_customer->getCustomer($cpm_customer_id);
						if ($cpm_customer['email'] && preg_match('/^[^\@]+@.*\.[a-z]{2,6}$/i', $cpm_customer['email']) && !in_array($cpm_customer_id, $cpm_customers_emailed)) {
							$mail->setTo($cpm_customer['email']);
							$mail->send();
							$cpm_customers_emailed[] = $cpm_customer_id;
						}
					}
				}
			}
			]]></add>
		</operation>
	</file>

	<file name="catalog/view/theme/default/template/mail/order.tpl">
		<operation>
			<search position="before"><![CDATA[
			<?php echo $text_product; ?>
			]]></search>
			<add><![CDATA[
			<?php if ($cpm_enabled) { ?><td style="font-size: 12px; border-right: 1px solid #DDDDDD; border-bottom: 1px solid #DDDDDD; background-color: #EFEFEF; font-weight: bold; text-align: left; padding: 7px; color: #222222;"><?php echo $text_image; ?></td><?php } ?>
			]]></add>
		</operation>
		<operation>
			<search position="before"><![CDATA[
			<?php echo $product['name']; ?>
			]]></search>
			<add><![CDATA[
			<?php if ($cpm_enabled) { ?><td style="font-size: 12px;	border-right: 1px solid #DDDDDD; border-bottom: 1px solid #DDDDDD; text-align: center; padding: 7px;"><img src="<?php echo $product['image']; ?>" alt="<?php echo $product['name']; ?>" style="padding: 1px; border: 1px solid #DDDDDD;" /></td><?php } ?>
			]]></add>
		</operation>
		<operation>
			<search position="before"><![CDATA[
			<?php echo $text_model; ?>
			]]></search>
			<add><![CDATA[
			<?php if ($cpm_enabled) { ?><td style="font-size: 12px; border-right: 1px solid #DDDDDD; border-bottom: 1px solid #DDDDDD; background-color: #EFEFEF; font-weight: bold; text-align: left; padding: 7px; color: #222222;"><?php echo $text_member; ?></td><?php } ?>
			]]></add>
		</operation>
		<operation>
			<search position="before"><![CDATA[
			<?php echo $product['model']; ?>
			]]></search>
			<add><![CDATA[
			<?php if ($cpm_enabled) { ?><td style="font-size: 12px;	border-right: 1px solid #DDDDDD; border-bottom: 1px solid #DDDDDD; text-align: left; padding: 7px;"><?php echo $product['member']; ?></td><?php } ?>
			]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[
			colspan="4"
			]]></search>
			<add><![CDATA[
			colspan="<?php echo ($cpm_enabled ? '6' : '4'); ?>"
			]]></add>
		</operation>
	</file>

	<file name="catalog/language/english/mail/order.php">
		<operation>
			<search position="bottom" offset="2"></search>
			<add><![CDATA[
			$_['text_member']	= 'Member';
			$_['text_image']	= 'Image';
			]]></add>
		</operation>
	</file>
	
	<!-- FRONT-END MISC -->
	
	<file name="catalog/model/design/layout.php">
		<operation>
			<search position="bottom" offset="2"></search>
			<add><![CDATA[
			public function getLayouts($data = array()) {
				$sql = "SELECT * FROM " . DB_PREFIX . "layout";
				
				$sort_data = array('name');	
				
				if (isset($data['sort']) && in_array($data['sort'], $sort_data)) {
					$sql .= " ORDER BY " . $data['sort'];	
				} else {
					$sql .= " ORDER BY name";	
				}
				
				if (isset($data['order']) && ($data['order'] == 'DESC')) {
					$sql .= " DESC";
				} else {
					$sql .= " ASC";
				}
				
				if (isset($data['start']) || isset($data['limit'])) {
					if ($data['start'] < 0) {
						$data['start'] = 0;
					}					
		
					if ($data['limit'] < 1) {
						$data['limit'] = 20;
					}	
				
					$sql .= " LIMIT " . (int)$data['start'] . "," . (int)$data['limit'];
				}		
				
				$query = $this->db->query($sql);
		
				return $query->rows;
			}
			]]></add>
		</operation>
	</file>
	
	<file name="catalog/model/tool/image.php">
		<operation>
			<search position="before"><![CDATA[
			function resize(
			]]></search>
			<add><![CDATA[
			public function resize_cpm($filename, $width, $height) {
				if (!file_exists($filename) || !is_file($filename)) {
					return;
				} 
				
				$image = new Image($filename);
				$image->resize($width, $height);
				$image->save($filename);
				
				if (isset($this->request->server['HTTPS']) && (($this->request->server['HTTPS'] == 'on') || ($this->request->server['HTTPS'] == '1'))) {
					return HTTPS_SERVER . 'image/' . $filename;
				} else {
					return HTTP_SERVER . 'image/' . $filename;
				}	
			}
			]]></add>
		</operation>
	</file>

	<!-- Uncomment the following to DISABLE rename and move functions of the Image Manager -->
	
	<!--
	<file name="catalog/controller/common/filemanager.php">
		<operation>
			<search position="replace" offset="40"><![CDATA[
			public function rename() {
			]]></search>
			<add><![CDATA[
			]]></add>
		</operation>
		<operation>
			<search position="replace" offset="40"><![CDATA[
			public function move() {
			]]></search>
			<add><![CDATA[
			]]></add>
		</operation>
	</file>

	<file name="catalog/view/theme/default/template/common/filemanager.tpl">
		<operation>
			<search position="replace"><![CDATA[
			<a id="rename" class="button" style="background-image: url('catalog/view/theme/default/image/filemanager/edit-rename.png');"><?php echo $button_rename; ?></a>
			]]></search>
			<add><![CDATA[
			]]></add>
		</operation>
		<operation>
			<search position="replace" offset="71"><![CDATA[
			$('#rename').bind('click', function() {
			]]></search>
			<add><![CDATA[
			]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[
			<a id="move" class="button" style="background-image: url('catalog/view/theme/default/image/filemanager/edit-cut.png');"><?php echo $button_move; ?></a>
			]]></search>
			<add><![CDATA[
			]]></add>
		</operation>
		<operation>
			<search position="replace" offset="73"><![CDATA[
			$('#move').bind('click', function() {
			]]></search>
			<add><![CDATA[
			]]></add>
		</operation>
	</file>
	-->
	
	<!-- end Uncomment -->
	
	<!-- END FRONT-END -->
	
</modification>